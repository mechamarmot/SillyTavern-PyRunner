version: '3.8'

services:
  # SillyTavern with PyRunner for testing
  sillytavern-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    ports:
      - "8000:8000"
    environment:
      - NODE_ENV=test
      - DISPLAY=:99
    volumes:
      - ./tests:/app/pyrunner-extension/tests
      - ./playwright.config.js:/app/pyrunner-extension/playwright.config.js
      - ./test-results:/app/pyrunner-extension/test-results
      - ./playwright-report:/app/pyrunner-extension/playwright-report
    command: >
      sh -c "
        cd /app/sillytavern &&
        node server.js &
        sleep 10 &&
        cd /app/pyrunner-extension &&
        npm test
      "

  # Standalone test runner (for running tests against existing SillyTavern)
  playwright-runner:
    image: mcr.microsoft.com/playwright:v1.40.0-jammy
    working_dir: /app
    volumes:
      - .:/app
    environment:
      - BASE_URL=${BASE_URL:-http://localhost:8000}
    command: npx playwright test
