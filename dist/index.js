(()=>{"use strict";function n(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function e(e){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?n(Object(o),!0).forEach((function(n){t(e,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):n(Object(o)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(o,n))}))}return e}function t(n,e,t){return(e=function(n){var e=function(n,e){if("object"!=typeof n||!n)return n;var t=n[Symbol.toPrimitive];if(void 0!==t){var r=t.call(n,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(n)}(n,"string");return"symbol"==typeof e?e:e+""}(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}class r{constructor(n){this.settings=n,this.mode=n.executionMode||"pyodide",this.pyodide=null,this.pyodideReady=!1,this.pyodideLoading=!1}getHeaders(){return e(e({},SillyTavern.getContext().getRequestHeaders()),{},{"Content-Type":"application/json"})}setMode(n){this.mode=n}async execute(n){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const t=e.mode||this.mode,r=e.timeout||this.settings.timeout||3e4;return"pyodide"===t?this.executePyodide(n,r):this.executeServer(n,r)}async executePyodide(n,e){return this.pyodideReady||await this.initPyodide(),new Promise(((t,r)=>{const o=setTimeout((()=>{r(new Error("Execution timed out"))}),e);try{let e;this.pyodide.runPython("\nimport sys\nfrom io import StringIO\nsys.stdout = StringIO()\nsys.stderr = StringIO()\n");try{e=this.pyodide.runPython(n)}catch(n){clearTimeout(o);const e=this.pyodide.runPython("sys.stderr.getvalue()");return void r(new Error(e||n.message))}const a=this.pyodide.runPython("sys.stdout.getvalue()");clearTimeout(o),a&&a.trim()?t(a.trim()):t(null!=e?String(e):"")}catch(n){clearTimeout(o),r(n)}}))}async initPyodide(){if(this.pyodideLoading)for(;this.pyodideLoading;)await new Promise((n=>setTimeout(n,100)));else if(!this.pyodideReady){this.pyodideLoading=!0;try{window.loadPyodide||await this.loadScript("https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"),this.pyodide=await window.loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"}),this.pyodideReady=!0,console.log("[PyRunner] Pyodide initialized")}catch(n){throw console.error("[PyRunner] Failed to initialize Pyodide:",n),new Error("Failed to initialize Pyodide: "+n.message)}finally{this.pyodideLoading=!1}}}loadScript(n){return new Promise(((e,t)=>{const r=document.createElement("script");r.src=n,r.onload=e,r.onerror=()=>t(new Error("Failed to load script: ".concat(n))),document.head.appendChild(r)}))}async executeServer(n,e){const t=new AbortController,r=setTimeout((()=>t.abort()),e);try{const o=await fetch("".concat(this.settings.serverUrl,"/execute"),{method:"POST",headers:this.getHeaders(),body:JSON.stringify({code:n,timeout:e}),signal:t.signal});if(clearTimeout(r),!o.ok){const n=await o.text();throw new Error(n||"Server error: ".concat(o.status))}const a=await o.json();if(a.error)throw new Error(a.error);return a.output||""}catch(n){if(clearTimeout(r),"AbortError"===n.name)throw new Error("Execution timed out");throw n}}async checkServerAvailable(){try{return(await fetch("".concat(this.settings.serverUrl,"/status"),{method:"GET"})).ok}catch(n){return!1}}}function o(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function a(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?o(Object(t),!0).forEach((function(e){i(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function i(n,e,t){return(e=function(n){var e=function(n,e){if("object"!=typeof n||!n)return n;var t=n[Symbol.toPrimitive];if(void 0!==t){var r=t.call(n,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(n)}(n,"string");return"symbol"==typeof e?e:e+""}(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}const s="SillyTavern-PyRunner",{eventSource:l,event_types:c,saveSettingsDebounced:u}=SillyTavern.getContext(),p={enabled:!1,executionMode:"pyodide",serverUrl:"/api/plugins/pyrunner",timeout:3e4};let d={},y=null;const g="/**\n * SillyTavern-PyRunner Server Plugin\n * Executes Python code on the local machine\n */\n\nconst { spawn } = require('child_process');\n\nconst info = {\n    id: 'pyrunner',\n    name: 'PyRunner',\n    description: 'Executes Python code on the local machine for the PyRunner extension',\n};\n\nfunction getPythonCommand() {\n    return process.platform === 'win32' ? 'python' : 'python3';\n}\n\nfunction executePython(code, timeout = 30000) {\n    return new Promise((resolve, reject) => {\n        const pythonCmd = getPythonCommand();\n        const proc = spawn(pythonCmd, ['-c', code], {\n            timeout: timeout,\n            maxBuffer: 1024 * 1024,\n            env: { ...process.env, PYTHONIOENCODING: 'utf-8' },\n        });\n\n        let stdout = '';\n        let stderr = '';\n\n        proc.stdout.on('data', (data) => { stdout += data.toString(); });\n        proc.stderr.on('data', (data) => { stderr += data.toString(); });\n\n        const timeoutId = setTimeout(() => {\n            proc.kill('SIGTERM');\n            reject(new Error('Execution timed out'));\n        }, timeout);\n\n        proc.on('close', (code) => {\n            clearTimeout(timeoutId);\n            if (code !== 0 && stderr) {\n                resolve({ output: stdout, error: stderr.trim() });\n            } else {\n                resolve({ output: stdout.trim(), error: null });\n            }\n        });\n\n        proc.on('error', (err) => {\n            clearTimeout(timeoutId);\n            reject(new Error('Failed to execute Python: ' + err.message));\n        });\n    });\n}\n\nfunction pipInstall(packages, timeout = 120000) {\n    return new Promise((resolve, reject) => {\n        const pythonCmd = getPythonCommand();\n        const args = ['-m', 'pip', 'install', ...packages.split(/\\s+/).filter(p => p)];\n        const proc = spawn(pythonCmd, args, {\n            timeout: timeout,\n            maxBuffer: 1024 * 1024,\n            env: { ...process.env, PYTHONIOENCODING: 'utf-8' },\n        });\n\n        let stdout = '';\n        let stderr = '';\n\n        proc.stdout.on('data', (data) => { stdout += data.toString(); });\n        proc.stderr.on('data', (data) => { stderr += data.toString(); });\n\n        const timeoutId = setTimeout(() => {\n            proc.kill('SIGTERM');\n            reject(new Error('Installation timed out'));\n        }, timeout);\n\n        proc.on('close', (code) => {\n            clearTimeout(timeoutId);\n            if (code !== 0) {\n                resolve({ output: stdout, error: stderr.trim() || 'Installation failed' });\n            } else {\n                resolve({ output: stdout.trim(), error: null });\n            }\n        });\n\n        proc.on('error', (err) => {\n            clearTimeout(timeoutId);\n            reject(new Error('Failed to run pip: ' + err.message));\n        });\n    });\n}\n\nasync function init(router) {\n    router.get('/status', (req, res) => {\n        res.json({ status: 'ok', plugin: info.name, python: getPythonCommand() });\n    });\n\n    router.post('/execute', async (req, res) => {\n        const { code, timeout = 30000 } = req.body;\n        if (!code || typeof code !== 'string') {\n            return res.status(400).json({ error: 'No code provided' });\n        }\n        const safeTimeout = Math.min(Math.max(parseInt(timeout) || 30000, 1000), 300000);\n        try {\n            const result = await executePython(code, safeTimeout);\n            if (result.error) {\n                return res.json({ output: result.output, error: result.error });\n            }\n            res.json({ output: result.output });\n        } catch (error) {\n            console.error('[PyRunner] Execution error:', error);\n            res.status(500).json({ error: error.message });\n        }\n    });\n\n    router.post('/install', async (req, res) => {\n        const { packages } = req.body;\n        if (!packages || typeof packages !== 'string') {\n            return res.status(400).json({ error: 'No packages specified' });\n        }\n        try {\n            const result = await pipInstall(packages);\n            if (result.error) {\n                return res.json({ output: result.output, error: result.error });\n            }\n            res.json({ output: result.output });\n        } catch (error) {\n            console.error('[PyRunner] Install error:', error);\n            res.status(500).json({ error: error.message });\n        }\n    });\n\n    console.log('[' + info.name + '] Plugin initialized');\n}\n\nasync function exit() {\n    console.log('[' + info.name + '] Plugin unloaded');\n}\n\nmodule.exports = { init, exit, info };\n";async function m(n){const e=document.querySelector("#pyrunner_packages_list");if(!e)return;const t=n.innerHTML;n.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',n.disabled=!0;try{const{getRequestHeaders:n}=SillyTavern.getContext(),t=await fetch("".concat(d.serverUrl,"/packages"),{method:"GET",headers:n()});if(!t.ok)throw new Error("Failed to fetch packages");const r=await t.json();if(r.error)return void(e.innerHTML='<span class="pyrunner-hint">Error: '.concat(r.error,"</span>"));if(!r.packages||0===r.packages.length)return void(e.innerHTML='<span class="pyrunner-hint">No packages found</span>');r.packages.sort(((n,e)=>n.name.localeCompare(e.name))),e.innerHTML=r.packages.map((n=>'<span class="pyrunner-package-item" data-package="'.concat(n.name,'">').concat(n.name,'<span class="pyrunner-package-version">').concat(n.version,"</span></span>"))).join(""),e.querySelectorAll(".pyrunner-package-item").forEach((n=>{n.addEventListener("click",(e=>{!function(n,e){const t=document.querySelector(".pyrunner-package-popup");t&&t.remove();const r=document.createElement("div");r.className="pyrunner-package-popup",r.innerHTML='\n        <div class="pyrunner-package-popup-item" data-action="copy">\n            <i class="fa-solid fa-copy"></i> Copy Name\n        </div>\n        <div class="pyrunner-package-popup-item danger" data-action="uninstall">\n            <i class="fa-solid fa-trash"></i> Uninstall\n        </div>\n    ',r.style.left="".concat(n.clientX,"px"),r.style.top="".concat(n.clientY,"px"),document.body.appendChild(r);const o=r.getBoundingClientRect();o.right>window.innerWidth&&(r.style.left="".concat(window.innerWidth-o.width-10,"px"));o.bottom>window.innerHeight&&(r.style.top="".concat(window.innerHeight-o.height-10,"px"));r.querySelector('[data-action="copy"]').addEventListener("click",(async()=>{try{await navigator.clipboard.writeText(e),window.toastr.success("Copied: ".concat(e))}catch(n){window.toastr.error("Failed to copy")}r.remove()})),r.querySelector('[data-action="uninstall"]').addEventListener("click",(async()=>{r.remove(),await async function(n){const e=window.toastr;if(!confirm('Are you sure you want to uninstall "'.concat(n,'"?')))return;e.info("Uninstalling ".concat(n,"..."));try{const{getRequestHeaders:t}=SillyTavern.getContext(),r=await fetch("".concat(d.serverUrl,"/uninstall"),{method:"POST",headers:a(a({},t()),{},{"Content-Type":"application/json"}),body:JSON.stringify({packages:n})});if(!r.ok)throw new Error("Server error");const o=await r.json();if(o.error)e.error("Failed to uninstall ".concat(n,": ").concat(o.error));else{e.success("Uninstalled ".concat(n));const t=document.querySelector("#pyrunner_refresh_packages");t&&m(t)}}catch(t){console.error("[".concat(s,"] Uninstall error:"),t),e.error("Failed to uninstall ".concat(n,": ").concat(t.message))}}(e)}));const i=n=>{r.contains(n.target)||(r.remove(),document.removeEventListener("click",i))};setTimeout((()=>document.addEventListener("click",i)),0)}(e,n.dataset.package)}))}))}catch(n){console.error("[".concat(s,"] Package list error:"),n),e.innerHTML='<span class="pyrunner-hint">Error: '.concat(n.message,"</span>")}finally{n.innerHTML=t,n.disabled=!1}}async function f(n,e){var t;const r=window.toastr;if(!(n=null===(t=n)||void 0===t?void 0:t.trim()))return void r.warning("Please enter package names to install");const o=e.innerHTML;e.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Installing...',e.disabled=!0;try{const{getRequestHeaders:e}=SillyTavern.getContext(),t=await fetch("".concat(d.serverUrl,"/install"),{method:"POST",headers:a(a({},e()),{},{"Content-Type":"application/json"}),body:JSON.stringify({packages:n})});if(!t.ok){const n=await t.text();throw new Error(n||"Server error")}const o=await t.json();var i;if(o.error)o.error.includes("already satisfied")||null!==(i=o.output)&&void 0!==i&&i.includes("already satisfied")?r.info("Package(s) already installed: ".concat(n)):r.error("Installation failed: ".concat(o.error));else o.output?o.output.includes("already satisfied")?r.info("Package(s) already installed: ".concat(n)):o.output.includes("Successfully installed")?r.success("Successfully installed: ".concat(n)):r.success("Installation complete: ".concat(n)):r.success("Installation complete: ".concat(n));const s=document.querySelector("#pyrunner_package_input");s&&(s.value="")}catch(n){console.error("[".concat(s,"] Package install error:"),n),r.error("Installation failed: ".concat(n.message))}finally{e.innerHTML=o,e.disabled=!1}}async function h(){const n=document.querySelector("#pyrunner_server_status");if(n)if("server"===d.executionMode)try{const e=await y.checkServerAvailable();n.textContent=e?"✓ Connected":"✗ Not available",n.className=e?"pyrunner-status-ok":"pyrunner-status-error"}catch(e){n.textContent="✗ Error",n.className="pyrunner-status-error"}else n.textContent="N/A",n.className="pyrunner-status-na"}l.on(c.APP_READY,(async function(){!function(){const n=SillyTavern.getContext();d=n.extensionSettings[s],d||(d=a({},p),n.extensionSettings[s]=d,u());for(const n in p)void 0===d[n]&&(d[n]=p[n])}(),y=new r(d),function(){const{SlashCommand:n,SlashCommandParser:e,SlashCommandArgument:t,ARGUMENT_TYPE:r,SlashCommandNamedArgument:o}=SillyTavern.getContext();e.addCommandObject(n.fromProps({name:"pyrun",callback:async(n,e)=>{if(!d.enabled)return"Error: PyRunner is disabled. Enable it in Extensions > PyRunner settings.";const t=(null==e?void 0:e.toString())||"";if(!t.trim())return"Error: No Python code provided";try{return await y.execute(t,{timeout:n.timeout?parseInt(n.timeout):d.timeout,mode:n.mode||d.executionMode})}catch(n){return console.error("[".concat(s,"] Execution error:"),n),"Error: ".concat(n.message)}},namedArgumentList:[o.fromProps({name:"mode",description:'Execution mode: "pyodide" (browser) or "server" (local Python)',typeList:[r.STRING],enumList:["pyodide","server"],defaultValue:null}),o.fromProps({name:"timeout",description:"Execution timeout in milliseconds",typeList:[r.NUMBER],defaultValue:null})],unnamedArgumentList:[t.fromProps({description:"Python code to execute",typeList:[r.STRING],isRequired:!0})],helpString:'\n            <div>\n                Executes Python code and returns the result.\n                <br><br>\n                <strong>Examples:</strong>\n                <ul>\n                    <li><code>/pyrun print("Hello, World!")</code></li>\n                    <li><code>/pyrun 2 + 2</code></li>\n                    <li><code>/pyrun mode=server import os; print(os.getcwd())</code></li>\n                </ul>\n                <br>\n                <strong>Modes:</strong>\n                <ul>\n                    <li><code>pyodide</code> - Runs in browser using WebAssembly (sandboxed, limited packages)</li>\n                    <li><code>server</code> - Runs on local machine via server plugin (full Python environment)</li>\n                </ul>\n            </div>\n        '})),console.log("[".concat(s,"] Slash command /pyrun registered")),e.addCommandObject(n.fromProps({name:"pyinstall",callback:async(n,e)=>{const t=(null==e?void 0:e.toString().trim())||"";if(!t)return"Error: No packages specified. Usage: /pyinstall numpy pandas";try{const{getRequestHeaders:n}=SillyTavern.getContext(),e=await fetch("".concat(d.serverUrl,"/install"),{method:"POST",headers:a(a({},n()),{},{"Content-Type":"application/json"}),body:JSON.stringify({packages:t})});if(!e.ok){const n=await e.text();throw new Error(n||"Server error")}const r=await e.json();return r.error?"Error: ".concat(r.error):r.output||"Packages installed successfully"}catch(n){return console.error("[".concat(s,"] Install error:"),n),"Error: ".concat(n.message)}},unnamedArgumentList:[t.fromProps({description:"Package names to install (space-separated)",typeList:[r.STRING],isRequired:!0})],helpString:"\n            <div>\n                Installs Python packages using pip (server mode only).\n                <br><br>\n                <strong>Examples:</strong>\n                <ul>\n                    <li><code>/pyinstall numpy</code></li>\n                    <li><code>/pyinstall pandas matplotlib</code></li>\n                </ul>\n            </div>\n        "})),console.log("[".concat(s,"] Slash command /pyinstall registered"))}(),function(){const n=function(n){const{enabled:e,executionMode:t,timeout:r}=n;return'\n        <div class="pyrunner-settings">\n            <div class="inline-drawer">\n                <div class="inline-drawer-toggle inline-drawer-header">\n                    <b>PyRunner</b>\n                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n                </div>\n                <div class="inline-drawer-content">\n                    <div class="pyrunner-settings-content">\n                        <div class="pyrunner-warning">\n                            <i class="fa-solid fa-triangle-exclamation"></i>\n                            <span>WARNING: USE AT YOUR OWN RISK</span>\n                        </div>\n\n                        <div class="pyrunner-toggle-row">\n                            <label for="pyrunner_enabled">Enable PyRunner</label>\n                            <input type="checkbox" id="pyrunner_enabled" '.concat(e?"checked":"",'>\n                        </div>\n\n                        <hr>\n\n                        <label class="pyrunner-label">Execution Mode</label>\n                        <div class="pyrunner-radio-group">\n                            <label class="radio-label">\n                                <input type="radio" name="pyrunner_mode" value="pyodide" ').concat("pyodide"===t?"checked":"",'>\n                                <span>Pyodide (Browser)</span>\n                                <small class="pyrunner-hint">Sandboxed, runs in WebAssembly. Limited to pure Python packages.</small>\n                            </label>\n                            <label class="radio-label">\n                                <input type="radio" name="pyrunner_mode" value="server" ').concat("server"===t?"checked":"",'>\n                                <span>Server (Local Python)</span>\n                                <small class="pyrunner-hint">Requires server plugin. Full Python environment with all packages.</small>\n                            </label>\n                        </div>\n\n                        <div class="pyrunner-plugin-install">\n                            <button id="pyrunner_install_plugin" class="menu_button" title="Reinstall server plugin using Files API (requires LennySuite Files plugin)">\n                                <i class="fa-solid fa-rotate"></i> Reinstall Plugin\n                            </button>\n                            <button id="pyrunner_copy_install_cmd" class="menu_button" title="Copy manual install instructions">\n                                <i class="fa-solid fa-copy"></i> Manual\n                            </button>\n                        </div>\n                        <small class="pyrunner-hint">Reinstall if plugin is outdated. Requires Files plugin. Restart after reinstall.</small>\n\n                        <div class="pyrunner-server-status-row">\n                            <label>Server Status:</label>\n                            <span id="pyrunner_server_status" class="pyrunner-status-na">N/A</span>\n                        </div>\n\n                        <div class="pyrunner-packages-section">\n                            <label class="pyrunner-label">Install Python Packages</label>\n                            <div class="pyrunner-packages-input-row">\n                                <input type="text" id="pyrunner_package_input" class="text_pole" placeholder="e.g. numpy pandas requests">\n                                <button id="pyrunner_install_packages" class="menu_button">\n                                    <i class="fa-solid fa-download"></i> Install\n                                </button>\n                            </div>\n                            <small class="pyrunner-hint">Space-separated package names. Uses pip install (server mode only).</small>\n\n                            <div class="pyrunner-packages-list-header">\n                                <label class="pyrunner-label">Installed Packages</label>\n                                <button id="pyrunner_refresh_packages" class="menu_button menu_button_icon" title="Refresh package list">\n                                    <i class="fa-solid fa-refresh"></i>\n                                </button>\n                            </div>\n                            <div id="pyrunner_packages_list" class="pyrunner-packages-list">\n                                <span class="pyrunner-hint">Click refresh to load packages</span>\n                            </div>\n                        </div>\n\n                        <label class="pyrunner-label" for="pyrunner_timeout">Timeout (ms)</label>\n                        <input type="number" id="pyrunner_timeout" class="text_pole" value="').concat(r,'" min="1000" max="300000" step="1000">\n                        <small class="pyrunner-hint">Maximum execution time before timeout (1000-300000 ms)</small>\n\n                        <hr>\n                        <div class="pyrunner-help">\n                            <div class="pyrunner-help-title">Usage:</div>\n                            <code>/pyrun &lt;python code&gt;</code>\n                            <br><br>\n                            <div class="pyrunner-help-title">Examples:</div>\n                            <ul>\n                                <li><code>/pyrun print("Hello!")</code></li>\n                                <li><code>/pyrun 2 + 2</code></li>\n                                <li><code>/pyrun mode=server import os; print(os.getcwd())</code></li>\n                            </ul>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            .pyrunner-settings-content {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                padding: 10px 0;\n            }\n\n            .pyrunner-warning {\n                background: #8b0000;\n                color: #fff;\n                padding: 10px 15px;\n                border-radius: 5px;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                font-weight: bold;\n            }\n\n            .pyrunner-warning i {\n                font-size: 1.2em;\n            }\n\n            .pyrunner-toggle-row {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 5px 0;\n            }\n\n            .pyrunner-toggle-row label {\n                font-weight: bold;\n            }\n\n            .pyrunner-label {\n                font-weight: bold;\n                margin-top: 5px;\n            }\n\n            .pyrunner-radio-group {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-left: 5px;\n            }\n\n            .pyrunner-radio-group .radio-label {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n                cursor: pointer;\n            }\n\n            .pyrunner-radio-group .radio-label > span {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n            }\n\n            .pyrunner-radio-group input[type="radio"] {\n                margin-right: 5px;\n            }\n\n            .pyrunner-hint {\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.7;\n                font-size: 0.85em;\n                margin-left: 20px;\n            }\n\n            .pyrunner-server-status-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                margin: 5px 0;\n            }\n\n            .pyrunner-status-ok {\n                color: #4caf50;\n                font-weight: bold;\n            }\n\n            .pyrunner-status-error {\n                color: #f44336;\n                font-weight: bold;\n            }\n\n            .pyrunner-status-na {\n                opacity: 0.7;\n            }\n\n            .pyrunner-help {\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 5px;\n                font-size: 0.9em;\n            }\n\n            .pyrunner-help-title {\n                font-weight: bold;\n                margin-bottom: 5px;\n            }\n\n            .pyrunner-help code {\n                background: rgba(0, 0, 0, 0.3);\n                color: inherit;\n                padding: 2px 6px;\n                border-radius: 3px;\n                font-family: monospace;\n            }\n\n            .pyrunner-help ul {\n                margin: 5px 0;\n                padding-left: 20px;\n            }\n\n            .pyrunner-help li {\n                margin: 3px 0;\n            }\n\n            .pyrunner-plugin-install {\n                display: flex;\n                gap: 10px;\n                flex-wrap: wrap;\n                margin: 5px 0;\n            }\n\n            .pyrunner-plugin-install .menu_button {\n                display: inline-flex;\n                align-items: center;\n                gap: 5px;\n                text-decoration: none;\n            }\n\n            .pyrunner-packages-section {\n                margin: 10px 0;\n            }\n\n            .pyrunner-packages-input-row {\n                display: flex;\n                gap: 10px;\n                align-items: center;\n            }\n\n            .pyrunner-packages-input-row input {\n                flex: 1;\n            }\n\n            .pyrunner-packages-input-row .menu_button {\n                display: inline-flex;\n                align-items: center;\n                gap: 5px;\n                white-space: nowrap;\n            }\n\n            .pyrunner-packages-list-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                margin-top: 10px;\n            }\n\n            .pyrunner-packages-list-header .menu_button_icon {\n                padding: 3px 8px;\n                min-width: unset;\n            }\n\n            .pyrunner-packages-list {\n                max-height: 150px;\n                overflow-y: auto;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                padding: 8px;\n                margin-top: 5px;\n                font-size: 0.85em;\n            }\n\n            .pyrunner-package-item {\n                display: inline-block;\n                background: rgba(0, 0, 0, 0.3);\n                padding: 2px 8px;\n                border-radius: 3px;\n                margin: 2px;\n            }\n\n            .pyrunner-package-version {\n                opacity: 0.7;\n                margin-left: 3px;\n            }\n\n            .pyrunner-package-item {\n                cursor: pointer;\n                transition: background 0.2s;\n            }\n\n            .pyrunner-package-item:hover {\n                background: rgba(255, 255, 255, 0.1);\n            }\n\n            .pyrunner-package-popup {\n                position: fixed;\n                background: var(--SmartThemeBlurTintColor, #333);\n                border: 1px solid var(--SmartThemeBorderColor, #555);\n                border-radius: 5px;\n                padding: 5px 0;\n                z-index: 10000;\n                box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n                min-width: 120px;\n            }\n\n            .pyrunner-package-popup-item {\n                padding: 8px 15px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .pyrunner-package-popup-item:hover {\n                background: rgba(255, 255, 255, 0.1);\n            }\n\n            .pyrunner-package-popup-item.danger {\n                color: #f44336;\n            }\n\n            .pyrunner-package-popup-item.danger:hover {\n                background: rgba(244, 67, 54, 0.2);\n            }\n        </style>\n    ')}({enabled:d.enabled,executionMode:d.executionMode,timeout:d.timeout}),e=document.getElementById("extensions_settings"),t=document.createElement("div");t.id="pyrunner_settings",t.innerHTML=n,e.appendChild(t);const r=t.querySelector("#pyrunner_enabled");r&&r.addEventListener("change",(n=>{d.enabled=n.target.checked,u()}));t.querySelectorAll('input[name="pyrunner_mode"]').forEach((n=>{n.addEventListener("change",(n=>{d.executionMode=n.target.value,y.setMode(n.target.value),u(),h()}))}));const o=t.querySelector("#pyrunner_timeout");o&&o.addEventListener("change",(n=>{d.timeout=parseInt(n.target.value)||p.timeout,u()}));const a=t.querySelector("#pyrunner_install_plugin");a&&a.addEventListener("click",(async()=>{await async function(n){const e=n.innerHTML;n.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Installing...',n.disabled=!0;try{const e=await async function(n,e){try{const t=await fetch("/api/plugins/files/put",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:n,text:e,overwrite:!0})});if(t.ok){const n=await t.json();if(!1!==n.ok)return{ok:!0};if(n.error)return{ok:!1,error:n.error}}}catch(n){}try{const t=await fetch("/api/plugins/files-v2/put",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:n,text:e,overwrite:!0})});if(t.ok){const n=await t.json();if(!1!==n.ok)return{ok:!0};if(n.error)return{ok:!1,error:n.error}}}catch(n){}return{ok:!1,error:"Files plugin not available. Please install LennySuite Files plugin first."}}("plugins/pyrunner/index.js",g);if(!e.ok)throw new Error(e.error||"Failed to write plugin file");n.innerHTML='<i class="fa-solid fa-check"></i> Installed!',alert("Server plugin installed successfully!\\n\\nPlease restart SillyTavern and enable server plugins in config.yaml:\\n\\nenableServerPlugins: true")}catch(e){console.error("[PyRunner] Install error:",e),n.innerHTML='<i class="fa-solid fa-times"></i> Failed',alert("Installation failed: "+e.message)}finally{setTimeout((()=>{n.innerHTML=e,n.disabled=!1}),3e3)}}(a)}));const i=t.querySelector("#pyrunner_copy_install_cmd");i&&i.addEventListener("click",(async()=>{const n="Copy the server-plugin/index.js file to SillyTavern/plugins/pyrunner/index.js";try{await navigator.clipboard.writeText(n);const e=i.innerHTML;i.innerHTML='<i class="fa-solid fa-check"></i> Copied!',setTimeout((()=>{i.innerHTML=e}),2e3)}catch(e){console.error("Failed to copy:",e),alert("Install instructions:\n\n"+n)}}));const s=t.querySelector("#pyrunner_install_packages"),l=t.querySelector("#pyrunner_package_input");s&&l&&(s.addEventListener("click",(async()=>{await f(l.value,s)})),l.addEventListener("keypress",(async n=>{"Enter"===n.key&&await f(l.value,s)})));const c=t.querySelector("#pyrunner_refresh_packages");c&&c.addEventListener("click",(async()=>{await m(c)}));h()}(),console.log("[".concat(s,"] Extension loaded"))}))})();