(()=>{"use strict";class e{constructor(e){this.settings=e,this.mode=e.executionMode||"pyodide",this.pyodide=null,this.pyodideReady=!1,this.pyodideLoading=!1}setMode(e){this.mode=e}async execute(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const t=n.mode||this.mode,r=n.timeout||this.settings.timeout||3e4;return"pyodide"===t?this.executePyodide(e,r):this.executeServer(e,r)}async executePyodide(e,n){return this.pyodideReady||await this.initPyodide(),new Promise(((t,r)=>{const o=setTimeout((()=>{r(new Error("Execution timed out"))}),n);try{let n;this.pyodide.runPython("\nimport sys\nfrom io import StringIO\nsys.stdout = StringIO()\nsys.stderr = StringIO()\n");try{n=this.pyodide.runPython(e)}catch(e){clearTimeout(o);const n=this.pyodide.runPython("sys.stderr.getvalue()");return void r(new Error(n||e.message))}const i=this.pyodide.runPython("sys.stdout.getvalue()");clearTimeout(o),i&&i.trim()?t(i.trim()):t(null!=n?String(n):"")}catch(e){clearTimeout(o),r(e)}}))}async initPyodide(){if(this.pyodideLoading)for(;this.pyodideLoading;)await new Promise((e=>setTimeout(e,100)));else if(!this.pyodideReady){this.pyodideLoading=!0;try{window.loadPyodide||await this.loadScript("https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"),this.pyodide=await window.loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"}),this.pyodideReady=!0,console.log("[PyRunner] Pyodide initialized")}catch(e){throw console.error("[PyRunner] Failed to initialize Pyodide:",e),new Error("Failed to initialize Pyodide: "+e.message)}finally{this.pyodideLoading=!1}}}loadScript(e){return new Promise(((n,t)=>{const r=document.createElement("script");r.src=e,r.onload=n,r.onerror=()=>t(new Error("Failed to load script: ".concat(e))),document.head.appendChild(r)}))}async executeServer(e,n){const t=new AbortController,r=setTimeout((()=>t.abort()),n);try{const o=await fetch("".concat(this.settings.serverUrl,"/execute"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e,timeout:n}),signal:t.signal});if(clearTimeout(r),!o.ok){const e=await o.text();throw new Error(e||"Server error: ".concat(o.status))}const i=await o.json();if(i.error)throw new Error(i.error);return i.output||""}catch(e){if(clearTimeout(r),"AbortError"===e.name)throw new Error("Execution timed out");throw e}}async checkServerAvailable(){try{return(await fetch("".concat(this.settings.serverUrl,"/status"),{method:"GET"})).ok}catch(e){return!1}}}function n(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function t(e,n,t){return(n=function(e){var n=function(e,n){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==typeof n?n:n+""}(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}const r="SillyTavern-PyRunner",{eventSource:o,event_types:i,saveSettingsDebounced:s}=SillyTavern.getContext(),a={executionMode:"pyodide",serverUrl:"/api/plugins/pyrunner",timeout:3e4};let d={},l=null;function u(){const e=SillyTavern.getContext();d=e.extensionSettings[r],d||(d=function(e){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?n(Object(o),!0).forEach((function(n){t(e,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):n(Object(o)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(o,n))}))}return e}({},a),e.extensionSettings[r]=d,s());for(const e in a)void 0===d[e]&&(d[e]=a[e])}async function c(){const e=document.querySelector("#pyrunner_server_status");if(e)if("server"===d.executionMode)try{const n=await l.checkServerAvailable();e.textContent=n?"✓ Connected":"✗ Not available",e.className=n?"pyrunner-status-ok":"pyrunner-status-error"}catch(n){e.textContent="✗ Error",e.className="pyrunner-status-error"}else e.textContent="N/A",e.className="pyrunner-status-na"}o.on(i.APP_READY,(async function(){u(),l=new e(d),function(){const{SlashCommand:e,SlashCommandParser:n,SlashCommandArgument:t,ARGUMENT_TYPE:o,SlashCommandNamedArgument:i}=SillyTavern.getContext();n.addCommandObject(e.fromProps({name:"pyrun",callback:async(e,n)=>{const t=(null==n?void 0:n.toString())||"";if(!t.trim())return"Error: No Python code provided";try{return await l.execute(t,{timeout:e.timeout?parseInt(e.timeout):d.timeout,mode:e.mode||d.executionMode})}catch(e){return console.error("[".concat(r,"] Execution error:"),e),"Error: ".concat(e.message)}},namedArgumentList:[i.fromProps({name:"mode",description:'Execution mode: "pyodide" (browser) or "server" (local Python)',typeList:[o.STRING],enumList:["pyodide","server"],defaultValue:null}),i.fromProps({name:"timeout",description:"Execution timeout in milliseconds",typeList:[o.NUMBER],defaultValue:null})],unnamedArgumentList:[t.fromProps({description:"Python code to execute",typeList:[o.STRING],isRequired:!0})],helpString:'\n            <div>\n                Executes Python code and returns the result.\n                <br><br>\n                <strong>Examples:</strong>\n                <ul>\n                    <li><code>/pyrun print("Hello, World!")</code></li>\n                    <li><code>/pyrun 2 + 2</code></li>\n                    <li><code>/pyrun mode=server import os; print(os.getcwd())</code></li>\n                </ul>\n                <br>\n                <strong>Modes:</strong>\n                <ul>\n                    <li><code>pyodide</code> - Runs in browser using WebAssembly (sandboxed, limited packages)</li>\n                    <li><code>server</code> - Runs on local machine via server plugin (full Python environment)</li>\n                </ul>\n            </div>\n        '})),console.log("[".concat(r,"] Slash command /pyrun registered"))}(),function(){const e=function(e){const{executionMode:n,timeout:t}=e;return'\n        <div class="pyrunner-settings">\n            <div class="inline-drawer">\n                <div class="inline-drawer-toggle inline-drawer-header">\n                    <b>PyRunner</b>\n                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n                </div>\n                <div class="inline-drawer-content">\n                    <div class="pyrunner-settings-content">\n                        <label class="pyrunner-label">Execution Mode</label>\n                        <div class="pyrunner-radio-group">\n                            <label class="radio-label">\n                                <input type="radio" name="pyrunner_mode" value="pyodide" '.concat("pyodide"===n?"checked":"",'>\n                                <span>Pyodide (Browser)</span>\n                                <small class="pyrunner-hint">Sandboxed, runs in WebAssembly. Limited to pure Python packages.</small>\n                            </label>\n                            <label class="radio-label">\n                                <input type="radio" name="pyrunner_mode" value="server" ').concat("server"===n?"checked":"",'>\n                                <span>Server (Local Python)</span>\n                                <small class="pyrunner-hint">Requires server plugin. Full Python environment with all packages.</small>\n                            </label>\n                        </div>\n\n                        <div class="pyrunner-server-status-row">\n                            <label>Server Status:</label>\n                            <span id="pyrunner_server_status" class="pyrunner-status-na">N/A</span>\n                        </div>\n\n                        <label class="pyrunner-label" for="pyrunner_timeout">Timeout (ms)</label>\n                        <input type="number" id="pyrunner_timeout" class="text_pole" value="').concat(t,'" min="1000" max="300000" step="1000">\n                        <small class="pyrunner-hint">Maximum execution time before timeout (1000-300000 ms)</small>\n\n                        <hr>\n                        <div class="pyrunner-help">\n                            <b>Usage:</b>\n                            <code>/pyrun &lt;python code&gt;</code>\n                            <br><br>\n                            <b>Examples:</b>\n                            <ul>\n                                <li><code>/pyrun print("Hello!")</code></li>\n                                <li><code>/pyrun 2 + 2</code></li>\n                                <li><code>/pyrun mode=server import os; print(os.getcwd())</code></li>\n                            </ul>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            .pyrunner-settings-content {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                padding: 10px 0;\n            }\n\n            .pyrunner-label {\n                font-weight: bold;\n                margin-top: 5px;\n            }\n\n            .pyrunner-radio-group {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-left: 5px;\n            }\n\n            .pyrunner-radio-group .radio-label {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n                cursor: pointer;\n            }\n\n            .pyrunner-radio-group .radio-label > span {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n            }\n\n            .pyrunner-radio-group input[type="radio"] {\n                margin-right: 5px;\n            }\n\n            .pyrunner-hint {\n                color: var(--SmartThemeQuoteColor);\n                font-size: 0.85em;\n                margin-left: 20px;\n            }\n\n            .pyrunner-server-status-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                margin: 5px 0;\n            }\n\n            .pyrunner-status-ok {\n                color: #4caf50;\n                font-weight: bold;\n            }\n\n            .pyrunner-status-error {\n                color: #f44336;\n                font-weight: bold;\n            }\n\n            .pyrunner-status-na {\n                color: var(--SmartThemeQuoteColor);\n            }\n\n            .pyrunner-help {\n                background: var(--SmartThemeBlurTintColor);\n                padding: 10px;\n                border-radius: 5px;\n                font-size: 0.9em;\n            }\n\n            .pyrunner-help code {\n                background: var(--SmartThemeBodyColor);\n                padding: 2px 5px;\n                border-radius: 3px;\n            }\n\n            .pyrunner-help ul {\n                margin: 5px 0;\n                padding-left: 20px;\n            }\n\n            .pyrunner-help li {\n                margin: 3px 0;\n            }\n        </style>\n    ')}({executionMode:d.executionMode,timeout:d.timeout,onModeChange:e=>{d.executionMode=e,l.setMode(e),s()},onTimeoutChange:e=>{d.timeout=e,s()}}),n=document.getElementById("extensions_settings"),t=document.createElement("div");t.id="pyrunner_settings",t.innerHTML=e,n.appendChild(t);t.querySelectorAll('input[name="pyrunner_mode"]').forEach((e=>{e.addEventListener("change",(e=>{d.executionMode=e.target.value,l.setMode(e.target.value),s(),c()}))}));const r=t.querySelector("#pyrunner_timeout");r&&r.addEventListener("change",(e=>{d.timeout=parseInt(e.target.value)||a.timeout,s()}));c()}(),console.log("[".concat(r,"] Extension loaded"))}))})();