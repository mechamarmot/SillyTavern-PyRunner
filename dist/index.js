(()=>{"use strict";class n{constructor(n){this.settings=n,this.mode=n.executionMode||"pyodide",this.pyodide=null,this.pyodideReady=!1,this.pyodideLoading=!1}setMode(n){this.mode=n}async execute(n){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const t=e.mode||this.mode,r=e.timeout||this.settings.timeout||3e4;return"pyodide"===t?this.executePyodide(n,r):this.executeServer(n,r)}async executePyodide(n,e){return this.pyodideReady||await this.initPyodide(),new Promise(((t,r)=>{const i=setTimeout((()=>{r(new Error("Execution timed out"))}),e);try{let e;this.pyodide.runPython("\nimport sys\nfrom io import StringIO\nsys.stdout = StringIO()\nsys.stderr = StringIO()\n");try{e=this.pyodide.runPython(n)}catch(n){clearTimeout(i);const e=this.pyodide.runPython("sys.stderr.getvalue()");return void r(new Error(e||n.message))}const o=this.pyodide.runPython("sys.stdout.getvalue()");clearTimeout(i),o&&o.trim()?t(o.trim()):t(null!=e?String(e):"")}catch(n){clearTimeout(i),r(n)}}))}async initPyodide(){if(this.pyodideLoading)for(;this.pyodideLoading;)await new Promise((n=>setTimeout(n,100)));else if(!this.pyodideReady){this.pyodideLoading=!0;try{window.loadPyodide||await this.loadScript("https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"),this.pyodide=await window.loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"}),this.pyodideReady=!0,console.log("[PyRunner] Pyodide initialized")}catch(n){throw console.error("[PyRunner] Failed to initialize Pyodide:",n),new Error("Failed to initialize Pyodide: "+n.message)}finally{this.pyodideLoading=!1}}}loadScript(n){return new Promise(((e,t)=>{const r=document.createElement("script");r.src=n,r.onload=e,r.onerror=()=>t(new Error("Failed to load script: ".concat(n))),document.head.appendChild(r)}))}async executeServer(n,e){const t=new AbortController,r=setTimeout((()=>t.abort()),e);try{const i=await fetch("".concat(this.settings.serverUrl,"/execute"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:n,timeout:e}),signal:t.signal});if(clearTimeout(r),!i.ok){const n=await i.text();throw new Error(n||"Server error: ".concat(i.status))}const o=await i.json();if(o.error)throw new Error(o.error);return o.output||""}catch(n){if(clearTimeout(r),"AbortError"===n.name)throw new Error("Execution timed out");throw n}}async checkServerAvailable(){try{return(await fetch("".concat(this.settings.serverUrl,"/status"),{method:"GET"})).ok}catch(n){return!1}}}function e(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function t(n,e,t){return(e=function(n){var e=function(n,e){if("object"!=typeof n||!n)return n;var t=n[Symbol.toPrimitive];if(void 0!==t){var r=t.call(n,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(n)}(n,"string");return"symbol"==typeof e?e:e+""}(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}const r="SillyTavern-PyRunner",{eventSource:i,event_types:o,saveSettingsDebounced:a}=SillyTavern.getContext(),s={enabled:!1,executionMode:"pyodide",serverUrl:"/api/plugins/pyrunner",timeout:3e4};let l={},u=null;function d(){const n=SillyTavern.getContext();l=n.extensionSettings[r],l||(l=function(n){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?e(Object(i),!0).forEach((function(e){t(n,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(i,e))}))}return n}({},s),n.extensionSettings[r]=l,a());for(const n in s)void 0===l[n]&&(l[n]=s[n])}const c="/**\n * SillyTavern-PyRunner Server Plugin\n * Executes Python code on the local machine\n */\n\nconst { spawn } = require('child_process');\n\nconst info = {\n    id: 'pyrunner',\n    name: 'PyRunner',\n    description: 'Executes Python code on the local machine for the PyRunner extension',\n};\n\nfunction getPythonCommand() {\n    return process.platform === 'win32' ? 'python' : 'python3';\n}\n\nfunction executePython(code, timeout = 30000) {\n    return new Promise((resolve, reject) => {\n        const pythonCmd = getPythonCommand();\n        const proc = spawn(pythonCmd, ['-c', code], {\n            timeout: timeout,\n            maxBuffer: 1024 * 1024,\n            env: { ...process.env, PYTHONIOENCODING: 'utf-8' },\n        });\n\n        let stdout = '';\n        let stderr = '';\n\n        proc.stdout.on('data', (data) => { stdout += data.toString(); });\n        proc.stderr.on('data', (data) => { stderr += data.toString(); });\n\n        const timeoutId = setTimeout(() => {\n            proc.kill('SIGTERM');\n            reject(new Error('Execution timed out'));\n        }, timeout);\n\n        proc.on('close', (code) => {\n            clearTimeout(timeoutId);\n            if (code !== 0 && stderr) {\n                resolve({ output: stdout, error: stderr.trim() });\n            } else {\n                resolve({ output: stdout.trim(), error: null });\n            }\n        });\n\n        proc.on('error', (err) => {\n            clearTimeout(timeoutId);\n            reject(new Error('Failed to execute Python: ' + err.message));\n        });\n    });\n}\n\nasync function init(router) {\n    router.get('/status', (req, res) => {\n        res.json({ status: 'ok', plugin: info.name, python: getPythonCommand() });\n    });\n\n    router.post('/execute', async (req, res) => {\n        const { code, timeout = 30000 } = req.body;\n        if (!code || typeof code !== 'string') {\n            return res.status(400).json({ error: 'No code provided' });\n        }\n        const safeTimeout = Math.min(Math.max(parseInt(timeout) || 30000, 1000), 300000);\n        try {\n            const result = await executePython(code, safeTimeout);\n            if (result.error) {\n                return res.json({ output: result.output, error: result.error });\n            }\n            res.json({ output: result.output });\n        } catch (error) {\n            console.error('[PyRunner] Execution error:', error);\n            res.status(500).json({ error: error.message });\n        }\n    });\n\n    console.log('[' + info.name + '] Plugin initialized');\n}\n\nasync function exit() {\n    console.log('[' + info.name + '] Plugin unloaded');\n}\n\nmodule.exports = { init, exit, info };\n";async function p(){const n=document.querySelector("#pyrunner_server_status");if(n)if("server"===l.executionMode)try{const e=await u.checkServerAvailable();n.textContent=e?"✓ Connected":"✗ Not available",n.className=e?"pyrunner-status-ok":"pyrunner-status-error"}catch(e){n.textContent="✗ Error",n.className="pyrunner-status-error"}else n.textContent="N/A",n.className="pyrunner-status-na"}i.on(o.APP_READY,(async function(){d(),u=new n(l),function(){const{SlashCommand:n,SlashCommandParser:e,SlashCommandArgument:t,ARGUMENT_TYPE:i,SlashCommandNamedArgument:o}=SillyTavern.getContext();e.addCommandObject(n.fromProps({name:"pyrun",callback:async(n,e)=>{if(!l.enabled)return"Error: PyRunner is disabled. Enable it in Extensions > PyRunner settings.";const t=(null==e?void 0:e.toString())||"";if(!t.trim())return"Error: No Python code provided";try{return await u.execute(t,{timeout:n.timeout?parseInt(n.timeout):l.timeout,mode:n.mode||l.executionMode})}catch(n){return console.error("[".concat(r,"] Execution error:"),n),"Error: ".concat(n.message)}},namedArgumentList:[o.fromProps({name:"mode",description:'Execution mode: "pyodide" (browser) or "server" (local Python)',typeList:[i.STRING],enumList:["pyodide","server"],defaultValue:null}),o.fromProps({name:"timeout",description:"Execution timeout in milliseconds",typeList:[i.NUMBER],defaultValue:null})],unnamedArgumentList:[t.fromProps({description:"Python code to execute",typeList:[i.STRING],isRequired:!0})],helpString:'\n            <div>\n                Executes Python code and returns the result.\n                <br><br>\n                <strong>Examples:</strong>\n                <ul>\n                    <li><code>/pyrun print("Hello, World!")</code></li>\n                    <li><code>/pyrun 2 + 2</code></li>\n                    <li><code>/pyrun mode=server import os; print(os.getcwd())</code></li>\n                </ul>\n                <br>\n                <strong>Modes:</strong>\n                <ul>\n                    <li><code>pyodide</code> - Runs in browser using WebAssembly (sandboxed, limited packages)</li>\n                    <li><code>server</code> - Runs on local machine via server plugin (full Python environment)</li>\n                </ul>\n            </div>\n        '})),console.log("[".concat(r,"] Slash command /pyrun registered"))}(),function(){const n=function(n){const{enabled:e,executionMode:t,timeout:r}=n;return'\n        <div class="pyrunner-settings">\n            <div class="inline-drawer">\n                <div class="inline-drawer-toggle inline-drawer-header">\n                    <b>PyRunner</b>\n                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n                </div>\n                <div class="inline-drawer-content">\n                    <div class="pyrunner-settings-content">\n                        <div class="pyrunner-warning">\n                            <i class="fa-solid fa-triangle-exclamation"></i>\n                            <span>WARNING: USE AT YOUR OWN RISK</span>\n                        </div>\n\n                        <div class="pyrunner-toggle-row">\n                            <label for="pyrunner_enabled">Enable PyRunner</label>\n                            <input type="checkbox" id="pyrunner_enabled" '.concat(e?"checked":"",'>\n                        </div>\n\n                        <hr>\n\n                        <label class="pyrunner-label">Execution Mode</label>\n                        <div class="pyrunner-radio-group">\n                            <label class="radio-label">\n                                <input type="radio" name="pyrunner_mode" value="pyodide" ').concat("pyodide"===t?"checked":"",'>\n                                <span>Pyodide (Browser)</span>\n                                <small class="pyrunner-hint">Sandboxed, runs in WebAssembly. Limited to pure Python packages.</small>\n                            </label>\n                            <label class="radio-label">\n                                <input type="radio" name="pyrunner_mode" value="server" ').concat("server"===t?"checked":"",'>\n                                <span>Server (Local Python)</span>\n                                <small class="pyrunner-hint">Requires server plugin. Full Python environment with all packages.</small>\n                            </label>\n                        </div>\n\n                        <div class="pyrunner-plugin-install">\n                            <button id="pyrunner_install_plugin" class="menu_button" title="Install server plugin using Files API (requires LennySuite Files plugin)">\n                                <i class="fa-solid fa-download"></i> Install Plugin\n                            </button>\n                            <button id="pyrunner_enable_plugins" class="menu_button" title="Enable server plugins in config.yaml">\n                                <i class="fa-solid fa-toggle-on"></i> Enable in Config\n                            </button>\n                            <button id="pyrunner_copy_install_cmd" class="menu_button" title="Copy manual install instructions">\n                                <i class="fa-solid fa-copy"></i> Manual\n                            </button>\n                        </div>\n                        <small class="pyrunner-hint">Requires LennySuite Files plugin. After install, restart SillyTavern.</small>\n\n                        <div class="pyrunner-server-status-row">\n                            <label>Server Status:</label>\n                            <span id="pyrunner_server_status" class="pyrunner-status-na">N/A</span>\n                        </div>\n\n                        <label class="pyrunner-label" for="pyrunner_timeout">Timeout (ms)</label>\n                        <input type="number" id="pyrunner_timeout" class="text_pole" value="').concat(r,'" min="1000" max="300000" step="1000">\n                        <small class="pyrunner-hint">Maximum execution time before timeout (1000-300000 ms)</small>\n\n                        <hr>\n                        <div class="pyrunner-help">\n                            <div class="pyrunner-help-title">Usage:</div>\n                            <code>/pyrun &lt;python code&gt;</code>\n                            <br><br>\n                            <div class="pyrunner-help-title">Examples:</div>\n                            <ul>\n                                <li><code>/pyrun print("Hello!")</code></li>\n                                <li><code>/pyrun 2 + 2</code></li>\n                                <li><code>/pyrun mode=server import os; print(os.getcwd())</code></li>\n                            </ul>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            .pyrunner-settings-content {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                padding: 10px 0;\n            }\n\n            .pyrunner-warning {\n                background: #8b0000;\n                color: #fff;\n                padding: 10px 15px;\n                border-radius: 5px;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                font-weight: bold;\n            }\n\n            .pyrunner-warning i {\n                font-size: 1.2em;\n            }\n\n            .pyrunner-toggle-row {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 5px 0;\n            }\n\n            .pyrunner-toggle-row label {\n                font-weight: bold;\n            }\n\n            .pyrunner-label {\n                font-weight: bold;\n                margin-top: 5px;\n            }\n\n            .pyrunner-radio-group {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-left: 5px;\n            }\n\n            .pyrunner-radio-group .radio-label {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n                cursor: pointer;\n            }\n\n            .pyrunner-radio-group .radio-label > span {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n            }\n\n            .pyrunner-radio-group input[type="radio"] {\n                margin-right: 5px;\n            }\n\n            .pyrunner-hint {\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.7;\n                font-size: 0.85em;\n                margin-left: 20px;\n            }\n\n            .pyrunner-server-status-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                margin: 5px 0;\n            }\n\n            .pyrunner-status-ok {\n                color: #4caf50;\n                font-weight: bold;\n            }\n\n            .pyrunner-status-error {\n                color: #f44336;\n                font-weight: bold;\n            }\n\n            .pyrunner-status-na {\n                opacity: 0.7;\n            }\n\n            .pyrunner-help {\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 5px;\n                font-size: 0.9em;\n            }\n\n            .pyrunner-help-title {\n                font-weight: bold;\n                margin-bottom: 5px;\n            }\n\n            .pyrunner-help code {\n                background: rgba(0, 0, 0, 0.3);\n                color: inherit;\n                padding: 2px 6px;\n                border-radius: 3px;\n                font-family: monospace;\n            }\n\n            .pyrunner-help ul {\n                margin: 5px 0;\n                padding-left: 20px;\n            }\n\n            .pyrunner-help li {\n                margin: 3px 0;\n            }\n\n            .pyrunner-plugin-install {\n                display: flex;\n                gap: 10px;\n                flex-wrap: wrap;\n                margin: 5px 0;\n            }\n\n            .pyrunner-plugin-install .menu_button {\n                display: inline-flex;\n                align-items: center;\n                gap: 5px;\n                text-decoration: none;\n            }\n        </style>\n    ')}({enabled:l.enabled,executionMode:l.executionMode,timeout:l.timeout}),e=document.getElementById("extensions_settings"),t=document.createElement("div");t.id="pyrunner_settings",t.innerHTML=n,e.appendChild(t);const r=t.querySelector("#pyrunner_enabled");r&&r.addEventListener("change",(n=>{l.enabled=n.target.checked,a()}));t.querySelectorAll('input[name="pyrunner_mode"]').forEach((n=>{n.addEventListener("change",(n=>{l.executionMode=n.target.value,u.setMode(n.target.value),a(),p()}))}));const i=t.querySelector("#pyrunner_timeout");i&&i.addEventListener("change",(n=>{l.timeout=parseInt(n.target.value)||s.timeout,a()}));const o=t.querySelector("#pyrunner_install_plugin");o&&o.addEventListener("click",(async()=>{await async function(n){const e=n.innerHTML;n.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Installing...',n.disabled=!0;try{if(!(await fetch("/api/plugins/files-v2/list?path=plugins")).ok)throw new Error("Files plugin not available. Please install LennySuite Files plugin first, or copy the plugin manually.");const e=await fetch("/api/plugins/files-v2/put",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:"plugins/pyrunner/index.js",text:c,overwrite:!0})});if(!e.ok){const n=await e.text();throw new Error("Failed to write plugin file: "+n)}const t=await e.json();if(!t.ok)throw new Error(t.error||"Failed to write plugin file");n.innerHTML='<i class="fa-solid fa-check"></i> Installed!',alert("Server plugin installed successfully!\\n\\nPlease restart SillyTavern and enable server plugins in config.yaml:\\n\\nenableServerPlugins: true")}catch(e){console.error("[PyRunner] Install error:",e),n.innerHTML='<i class="fa-solid fa-times"></i> Failed',alert("Installation failed: "+e.message)}finally{setTimeout((()=>{n.innerHTML=e,n.disabled=!1}),3e3)}}(o)}));const d=t.querySelector("#pyrunner_enable_plugins");d&&d.addEventListener("click",(async()=>{await async function(n){const e=n.innerHTML;n.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Updating...',n.disabled=!0;try{const e=await fetch("/api/plugins/files-v2/get?path=config.yaml");if(!e.ok)throw new Error("Files plugin not available. Please manually edit config.yaml and set enableServerPlugins: true");const t=await e.json();if(!t.ok)throw new Error("Could not read config.yaml: "+(t.error||"Unknown error"));let r=t.data.text||"";if(/enableServerPlugins:\s*true/i.test(r))return n.innerHTML='<i class="fa-solid fa-check"></i> Already Enabled',void alert("Server plugins are already enabled in config.yaml");r=/enableServerPlugins:\s*false/i.test(r)?r.replace(/enableServerPlugins:\s*false/i,"enableServerPlugins: true"):/enableServerPlugins:/i.test(r)?r.replace(/enableServerPlugins:\s*\S*/i,"enableServerPlugins: true"):r.trimEnd()+"\\nenableServerPlugins: true\\n";const i=await fetch("/api/plugins/files-v2/put",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:"config.yaml",text:r,overwrite:!0})});if(!i.ok)throw new Error("Failed to write config.yaml");const o=await i.json();if(!o.ok)throw new Error(o.error||"Failed to update config.yaml");n.innerHTML='<i class="fa-solid fa-check"></i> Enabled!',alert("Server plugins enabled!\\n\\nPlease restart SillyTavern for changes to take effect.")}catch(e){console.error("[PyRunner] Config update error:",e),n.innerHTML='<i class="fa-solid fa-times"></i> Failed',alert("Failed to update config: "+e.message)}finally{setTimeout((()=>{n.innerHTML=e,n.disabled=!1}),3e3)}}(d)}));const y=t.querySelector("#pyrunner_copy_install_cmd");y&&y.addEventListener("click",(async()=>{const n="Copy the server-plugin/index.js file to SillyTavern/plugins/pyrunner/index.js";try{await navigator.clipboard.writeText(n);const e=y.innerHTML;y.innerHTML='<i class="fa-solid fa-check"></i> Copied!',setTimeout((()=>{y.innerHTML=e}),2e3)}catch(e){console.error("Failed to copy:",e),alert("Install instructions:\n\n"+n)}}));p()}(),console.log("[".concat(r,"] Extension loaded"))}))})();