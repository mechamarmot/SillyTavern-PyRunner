(()=>{"use strict";function n(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function e(e){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?n(Object(o),!0).forEach((function(n){t(e,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):n(Object(o)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(o,n))}))}return e}function t(n,e,t){return(e=function(n){var e=function(n,e){if("object"!=typeof n||!n)return n;var t=n[Symbol.toPrimitive];if(void 0!==t){var r=t.call(n,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(n)}(n,"string");return"symbol"==typeof e?e:e+""}(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}class r{constructor(n){this.settings=n,this.mode=n.executionMode||"pyodide",this.pyodide=null,this.pyodideReady=!1,this.pyodideLoading=!1}getHeaders(){return e(e({},SillyTavern.getContext().getRequestHeaders()),{},{"Content-Type":"application/json"})}setMode(n){this.mode=n}async execute(n){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const t=e.mode||this.mode,r=e.timeout||this.settings.timeout||3e4,o=e.venv||this.settings.selectedVenv||"default";return"pyodide"===t?this.executePyodide(n,r):this.executeServer(n,r,o)}async executePyodide(n,e){return this.pyodideReady||await this.initPyodide(),new Promise(((t,r)=>{const o=setTimeout((()=>{r(new Error("Execution timed out"))}),e);try{let e;this.pyodide.runPython("\nimport sys\nfrom io import StringIO\nsys.stdout = StringIO()\nsys.stderr = StringIO()\n");try{e=this.pyodide.runPython(n)}catch(n){clearTimeout(o);const e=this.pyodide.runPython("sys.stderr.getvalue()");return void r(new Error(e||n.message))}const a=this.pyodide.runPython("sys.stdout.getvalue()");clearTimeout(o),a&&a.trim()?t(a.trim()):t(null!=e?String(e):"")}catch(n){clearTimeout(o),r(n)}}))}async initPyodide(){if(this.pyodideLoading)for(;this.pyodideLoading;)await new Promise((n=>setTimeout(n,100)));else if(!this.pyodideReady){this.pyodideLoading=!0;try{window.loadPyodide||await this.loadScript("https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"),this.pyodide=await window.loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"}),this.pyodideReady=!0,console.log("[PyRunner] Pyodide initialized")}catch(n){throw console.error("[PyRunner] Failed to initialize Pyodide:",n),new Error("Failed to initialize Pyodide: "+n.message)}finally{this.pyodideLoading=!1}}}loadScript(n){return new Promise(((e,t)=>{const r=document.createElement("script");r.src=n,r.onload=e,r.onerror=()=>t(new Error("Failed to load script: ".concat(n))),document.head.appendChild(r)}))}async executeServer(n,e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"default";const r=new AbortController,o=setTimeout((()=>r.abort()),e);try{const a=await fetch("".concat(this.settings.serverUrl,"/execute"),{method:"POST",headers:this.getHeaders(),body:JSON.stringify({code:n,timeout:e,venv:t}),signal:r.signal});if(clearTimeout(o),!a.ok){const n=await a.text();throw new Error(n||"Server error: ".concat(a.status))}const s=await a.json();if(s.error)throw new Error(s.error);return s.output||""}catch(n){if(clearTimeout(o),"AbortError"===n.name)throw new Error("Execution timed out");throw n}}async checkServerAvailable(){try{return(await fetch("".concat(this.settings.serverUrl,"/status"),{method:"GET"})).ok}catch(n){return!1}}}function o(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,r)}return t}function a(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?o(Object(t),!0).forEach((function(e){s(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function s(n,e,t){return(e=function(n){var e=function(n,e){if("object"!=typeof n||!n)return n;var t=n[Symbol.toPrimitive];if(void 0!==t){var r=t.call(n,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(n)}(n,"string");return"symbol"==typeof e?e:e+""}(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}const c="SillyTavern-PyRunner",{eventSource:i,event_types:l,saveSettingsDebounced:u}=SillyTavern.getContext(),d={enabled:!1,executionMode:"pyodide",serverUrl:"/api/plugins/pyrunner",timeout:3e4,selectedVenv:"default",functionScope:"character",selectedCharacter:null,functions:{global:{},character:{}}},p=["False","None","True","and","as","assert","async","await","break","class","continue","def","del","elif","else","except","finally","for","from","global","if","import","in","is","lambda","nonlocal","not","or","pass","raise","return","try","while","with","yield"];let y={},v=null;function f(){return"server"===y.executionMode?y.selectedVenv||"default":"pyodide"}function m(){if("character"!==y.functionScope)return null;if(y.selectedCharacter)return y.selectedCharacter;const n=function(){const n=SillyTavern.getContext(),e=n.characterId;if(null!=e){const t=(n.characters||[])[e];return(null==t?void 0:t.avatar)||"char_".concat(e)}return null}();return n&&(y.selectedCharacter=n,u()),n}function g(n,e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=y.functions[n];if(!r)return[];if("character"===n){const n=t||m();if(!n)return[];const o=r[n];return o&&o[e]||[]}return r[e]||[]}function h(){return g(y.functionScope||"character",f())}function b(){const n=y.functionScope||"character";if("character"===n){var e;const t=m();return t&&(null===(e=y.functions[n])||void 0===e?void 0:e[t])||{}}return y.functions[n]||{}}function x(n){const e=y.functionScope||"character",t=f();let r={};if("character"===e){var o;const n=m();if(!n)return null;r=(null===(o=y.functions[e])||void 0===o?void 0:o[n])||{}}else r=y.functions[e]||{};const a=(r[t]||[]).find((e=>e.name===n));if(a)return{func:a,key:t,scope:e};for(const o of Object.keys(r)){if(o===t)continue;const a=(r[o]||[]).find((e=>e.name===n));if(a)return{func:a,key:o,scope:e}}return null}function _(n){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const t=(r=n.name)&&"string"==typeof r?/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(r)?p.includes(r)?{valid:!1,error:'"'.concat(r,'" is a Python keyword and cannot be used as a function name')}:{valid:!0}:{valid:!1,error:"Function name must be a valid Python identifier (letters, numbers, underscores, cannot start with number)"}:{valid:!1,error:"Function name is required"};var r;if(!t.valid)return{success:!1,error:t.error};if(!n.code||!n.code.trim())return{success:!1,error:"Function code is required"};const o=y.functionScope||"character",a=e||f();let s;if(y.functions[o]||(y.functions[o]={}),"character"===o){const n=m();if(!n)return{success:!1,error:"No character selected"};y.functions[o][n]||(y.functions[o][n]={}),y.functions[o][n][a]||(y.functions[o][n][a]=[]),s=y.functions[o][n][a]}else y.functions[o][a]||(y.functions[o][a]=[]),s=y.functions[o][a];const c=s.findIndex((e=>e.name===n.name)),i=Date.now(),l={name:n.name,description:n.description||"",code:n.code,arguments:n.arguments||[],created:c>=0?s[c].created:i,modified:i};return c>=0?s[c]=l:s.push(l),u(),{success:!0}}function w(n){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const t=y.functionScope||"character",r=e||f();let o;if("character"===t){var a;const n=m();if(!n)return{success:!1,error:"No character selected"};if(null===(a=y.functions[t])||void 0===a||null===(a=a[n])||void 0===a||!a[r])return{success:!1,error:"Function not found"};o=y.functions[t][n][r]}else{var s;if(null===(s=y.functions[t])||void 0===s||!s[r])return{success:!1,error:"Function not found"};o=y.functions[t][r]}const c=o.findIndex((e=>e.name===n));return c<0?{success:!1,error:'Function "'.concat(n,'" not found')}:(o.splice(c,1),u(),{success:!0})}function S(){const n=b();let e=0;for(const t of Object.keys(n))e+=(n[t]||[]).length;return e}const k="/**\n * SillyTavern-PyRunner Server Plugin\n * Executes Python code on the local machine with venv support\n */\n\nconst { spawn } = require('child_process');\nconst path = require('path');\nconst fs = require('fs');\n\nconst info = {\n    id: 'pyrunner',\n    name: 'PyRunner',\n    description: 'Executes Python code on the local machine for the PyRunner extension',\n};\n\nconst VENVS_DIR = path.join(__dirname, 'venvs');\nif (!fs.existsSync(VENVS_DIR)) {\n    fs.mkdirSync(VENVS_DIR, { recursive: true });\n}\n\nfunction getPythonCommand() {\n    return process.platform === 'win32' ? 'python' : 'python3';\n}\n\nfunction getVenvPython(venvName = 'default') {\n    const venvPath = path.join(VENVS_DIR, venvName);\n    return process.platform === 'win32'\n        ? path.join(venvPath, 'Scripts', 'python.exe')\n        : path.join(venvPath, 'bin', 'python');\n}\n\nfunction venvExists(venvName) {\n    return fs.existsSync(getVenvPython(venvName));\n}\n\nfunction isValidVenvName(name) {\n    return /^[a-zA-Z0-9]+$/.test(name);\n}\n\nfunction createVenv(venvName) {\n    return new Promise((resolve) => {\n        const venvPath = path.join(VENVS_DIR, venvName);\n        const proc = spawn(getPythonCommand(), ['-m', 'venv', venvPath], { timeout: 120000 });\n        let stderr = '';\n        proc.stderr.on('data', (data) => { stderr += data.toString(); });\n        proc.on('close', (code) => {\n            resolve(code === 0 ? { success: true } : { success: false, error: stderr.trim() || 'Failed to create venv' });\n        });\n        proc.on('error', (err) => resolve({ success: false, error: err.message }));\n    });\n}\n\nfunction deleteVenv(venvName) {\n    return new Promise((resolve) => {\n        try {\n            fs.rmSync(path.join(VENVS_DIR, venvName), { recursive: true, force: true });\n            resolve({ success: true });\n        } catch (err) {\n            resolve({ success: false, error: err.message });\n        }\n    });\n}\n\nfunction listVenvs() {\n    if (!fs.existsSync(VENVS_DIR)) return [];\n    return fs.readdirSync(VENVS_DIR).filter(name => {\n        return fs.statSync(path.join(VENVS_DIR, name)).isDirectory() && venvExists(name);\n    });\n}\n\nasync function ensureDefaultVenv() {\n    if (!venvExists('default')) {\n        console.log('[PyRunner] Creating default venv...');\n        const result = await createVenv('default');\n        if (result.success) console.log('[PyRunner] Default venv created');\n        else console.error('[PyRunner] Failed:', result.error);\n    }\n}\n\nfunction executePython(code, timeout = 30000, venvName = 'default') {\n    return new Promise((resolve, reject) => {\n        const proc = spawn(getVenvPython(venvName), ['-c', code], {\n            timeout, maxBuffer: 1024 * 1024, env: { ...process.env, PYTHONIOENCODING: 'utf-8' }\n        });\n        let stdout = '', stderr = '';\n        proc.stdout.on('data', (d) => { stdout += d.toString(); });\n        proc.stderr.on('data', (d) => { stderr += d.toString(); });\n        const tid = setTimeout(() => { proc.kill('SIGTERM'); reject(new Error('Timeout')); }, timeout);\n        proc.on('close', (code) => {\n            clearTimeout(tid);\n            resolve(code !== 0 && stderr ? { output: stdout, error: stderr.trim() } : { output: stdout.trim(), error: null });\n        });\n        proc.on('error', (e) => { clearTimeout(tid); reject(new Error('Failed: ' + e.message)); });\n    });\n}\n\nfunction pipInstall(packages, timeout = 120000, venvName = 'default') {\n    return new Promise((resolve, reject) => {\n        const args = ['-m', 'pip', 'install', ...packages.split(/\\s+/).filter(p => p)];\n        const proc = spawn(getVenvPython(venvName), args, {\n            timeout, maxBuffer: 1024 * 1024, env: { ...process.env, PYTHONIOENCODING: 'utf-8' }\n        });\n        let stdout = '', stderr = '';\n        proc.stdout.on('data', (d) => { stdout += d.toString(); });\n        proc.stderr.on('data', (d) => { stderr += d.toString(); });\n        const tid = setTimeout(() => { proc.kill('SIGTERM'); reject(new Error('Timeout')); }, timeout);\n        proc.on('close', (code) => {\n            clearTimeout(tid);\n            resolve(code !== 0 ? { output: stdout, error: stderr.trim() || 'Failed' } : { output: stdout.trim(), error: null });\n        });\n        proc.on('error', (e) => { clearTimeout(tid); reject(new Error('Failed: ' + e.message)); });\n    });\n}\n\nfunction checkPipAvailable(venvName = 'default') {\n    return new Promise((resolve) => {\n        const proc = spawn(getVenvPython(venvName), ['-m', 'pip', '--version'], { timeout: 10000 });\n        proc.on('close', (code) => resolve(code === 0));\n        proc.on('error', () => resolve(false));\n    });\n}\n\nasync function init(router) {\n    await ensureDefaultVenv();\n\n    router.get('/status', async (req, res) => {\n        res.json({ status: 'ok', plugin: info.name, python: getPythonCommand(), venvs: listVenvs(), defaultVenvReady: venvExists('default') });\n    });\n\n    router.get('/venvs', (req, res) => res.json({ venvs: listVenvs() }));\n\n    router.post('/venvs', async (req, res) => {\n        const { name } = req.body;\n        if (!name) return res.status(400).json({ error: 'No name' });\n        if (!isValidVenvName(name)) return res.status(400).json({ error: 'Invalid name' });\n        if (venvExists(name)) return res.status(400).json({ error: 'Already exists' });\n        const result = await createVenv(name);\n        result.success ? res.json({ success: true }) : res.status(500).json({ error: result.error });\n    });\n\n    router.delete('/venvs/:name', async (req, res) => {\n        const { name } = req.params;\n        if (name === 'default') return res.status(400).json({ error: 'Cannot delete default' });\n        if (!venvExists(name)) return res.status(404).json({ error: 'Not found' });\n        const result = await deleteVenv(name);\n        result.success ? res.json({ success: true }) : res.status(500).json({ error: result.error });\n    });\n\n    router.post('/execute', async (req, res) => {\n        const { code, timeout = 30000, venv = 'default' } = req.body;\n        if (!code) return res.status(400).json({ error: 'No code' });\n        if (!venvExists(venv)) return res.status(400).json({ error: 'Venv not found' });\n        try {\n            const result = await executePython(code, Math.min(Math.max(parseInt(timeout) || 30000, 1000), 300000), venv);\n            res.json(result.error ? { output: result.output, error: result.error } : { output: result.output });\n        } catch (e) { res.status(500).json({ error: e.message }); }\n    });\n\n    router.post('/install', async (req, res) => {\n        const { packages, venv = 'default' } = req.body;\n        if (!packages) return res.status(400).json({ error: 'No packages' });\n        if (!venvExists(venv)) return res.status(400).json({ error: 'Venv not found' });\n        if (!(await checkPipAvailable(venv))) return res.status(400).json({ error: 'pip unavailable' });\n        try {\n            const result = await pipInstall(packages, 120000, venv);\n            res.json(result.error ? { output: result.output, error: result.error } : { output: result.output });\n        } catch (e) { res.status(500).json({ error: e.message }); }\n    });\n\n    router.post('/uninstall', async (req, res) => {\n        const { packages, venv = 'default' } = req.body;\n        if (!packages) return res.status(400).json({ error: 'No packages' });\n        if (!venvExists(venv)) return res.status(400).json({ error: 'Venv not found' });\n        if (!(await checkPipAvailable(venv))) return res.status(400).json({ error: 'pip unavailable' });\n        const args = ['-m', 'pip', 'uninstall', '-y', ...packages.split(/\\s+/).filter(p => p)];\n        const proc = spawn(getVenvPython(venv), args, { timeout: 120000, maxBuffer: 1024 * 1024 });\n        let stdout = '', stderr = '';\n        proc.stdout.on('data', (d) => { stdout += d.toString(); });\n        proc.stderr.on('data', (d) => { stderr += d.toString(); });\n        proc.on('close', (code) => res.json(code !== 0 ? { output: stdout, error: stderr.trim() || 'Failed' } : { output: stdout.trim() }));\n        proc.on('error', (e) => res.status(500).json({ error: e.message }));\n    });\n\n    router.get('/packages', async (req, res) => {\n        const venv = req.query.venv || 'default';\n        if (!venvExists(venv)) return res.json({ packages: [], error: 'Venv not found' });\n        if (!(await checkPipAvailable(venv))) return res.json({ packages: [], error: 'pip unavailable' });\n        const proc = spawn(getVenvPython(venv), ['-m', 'pip', 'list', '--format=freeze'], { timeout: 30000, maxBuffer: 1024 * 1024 });\n        let stdout = '', stderr = '';\n        proc.stdout.on('data', (d) => { stdout += d.toString(); });\n        proc.stderr.on('data', (d) => { stderr += d.toString(); });\n        proc.on('close', (code) => {\n            if (code !== 0 && !stdout) return res.json({ packages: [], error: stderr.trim() || 'Failed' });\n            const packages = stdout.split('\\n').filter(p => p.trim()).map(p => {\n                const [name, version] = p.split('==');\n                return { name: name || p, version: version || '' };\n            });\n            res.json({ packages });\n        });\n        proc.on('error', (e) => res.status(500).json({ error: e.message }));\n    });\n\n    console.log('[' + info.name + '] Plugin initialized');\n}\n\nasync function exit() { console.log('[' + info.name + '] Plugin unloaded'); }\n\nmodule.exports = { init, exit, info };\n";async function E(){const n=document.querySelector("#pyrunner_venv_select");if(n)try{const{getRequestHeaders:e}=SillyTavern.getContext(),t=await fetch("".concat(y.serverUrl,"/venvs"),{method:"GET",headers:e()});if(!t.ok)throw new Error("Failed to fetch venvs");const r=(await t.json()).venvs||[],o=y.selectedVenv||"default";n.innerHTML="",r.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,e===o&&(t.selected=!0),n.appendChild(t)})),!r.includes(o)&&r.length>0&&(y.selectedVenv=r[0],n.value=r[0],u()),T()}catch(n){console.error("[".concat(c,"] Venv list error:"),n)}}async function P(){var n;const e=window.toastr,t=document.querySelector("#pyrunner_venv_name"),r=null==t||null===(n=t.value)||void 0===n?void 0:n.trim();if(!r)return void e.warning("Please enter a venv name");if(!/^[a-zA-Z0-9]+$/.test(r))return void e.error("Venv name must be alphanumeric only (no spaces or special characters)");const o=document.querySelector("#pyrunner_create_venv");o&&(o.disabled=!0,o.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>');try{const{getRequestHeaders:n}=SillyTavern.getContext(),o=await fetch("".concat(y.serverUrl,"/venvs"),{method:"POST",headers:a(a({},n()),{},{"Content-Type":"application/json"}),body:JSON.stringify({name:r})}),s=await o.json();if(!o.ok||s.error)return void e.error(s.error||"Failed to create venv");e.success('Venv "'.concat(r,'" created successfully')),t.value="",await E(),y.selectedVenv=r;const c=document.querySelector("#pyrunner_venv_select");c&&(c.value=r),u();const i=document.querySelector("#pyrunner_refresh_packages");i&&await j(i)}catch(n){console.error("[".concat(c,"] Create venv error:"),n),e.error("Failed to create venv: ".concat(n.message))}finally{o&&(o.disabled=!1,o.innerHTML='<i class="fa-solid fa-plus"></i> Create')}}function T(){const n=document.querySelector("#pyrunner_delete_venv");if(n){const e="default"===y.selectedVenv||!y.selectedVenv;n.disabled=e,n.title=e?"Cannot delete the default venv":"Delete selected venv"}}async function j(n){const e=document.querySelector("#pyrunner_packages_list");if(!e)return;const t=n.innerHTML;n.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',n.disabled=!0;const r=y.selectedVenv||"default";try{const{getRequestHeaders:n}=SillyTavern.getContext(),t=await fetch("".concat(y.serverUrl,"/packages?venv=").concat(encodeURIComponent(r)),{method:"GET",headers:n()});if(!t.ok)throw new Error("Failed to fetch packages");const o=await t.json();if(o.error)return void(e.innerHTML='<span class="pyrunner-hint">Error: '.concat(o.error,"</span>"));if(!o.packages||0===o.packages.length)return void(e.innerHTML='<span class="pyrunner-hint">No packages found</span>');o.packages.sort(((n,e)=>n.name.localeCompare(e.name))),e.innerHTML=o.packages.map((n=>'<span class="pyrunner-package-item" data-package="'.concat(n.name,'">').concat(n.name,'<span class="pyrunner-package-version">').concat(n.version,"</span></span>"))).join(""),e.querySelectorAll(".pyrunner-package-item").forEach((n=>{n.addEventListener("click",(e=>{!function(n,e){const t=document.querySelector(".pyrunner-package-popup");t&&t.remove();const r=document.createElement("div");r.className="pyrunner-package-popup",r.innerHTML='\n        <div class="pyrunner-package-popup-item" data-action="copy">\n            <i class="fa-solid fa-copy"></i> Copy Name\n        </div>\n        <div class="pyrunner-package-popup-item danger" data-action="uninstall">\n            <i class="fa-solid fa-trash"></i> Uninstall\n        </div>\n    ',r.style.left="".concat(n.clientX,"px"),r.style.top="".concat(n.clientY,"px"),document.body.appendChild(r);const o=r.getBoundingClientRect();o.right>window.innerWidth&&(r.style.left="".concat(window.innerWidth-o.width-10,"px"));o.bottom>window.innerHeight&&(r.style.top="".concat(window.innerHeight-o.height-10,"px"));r.querySelector('[data-action="copy"]').addEventListener("click",(async()=>{try{await navigator.clipboard.writeText(e),window.toastr.success("Copied: ".concat(e))}catch(n){window.toastr.error("Failed to copy")}r.remove()})),r.querySelector('[data-action="uninstall"]').addEventListener("click",(async()=>{r.remove(),await async function(n){const e=window.toastr;if(!confirm('Are you sure you want to uninstall "'.concat(n,'"?')))return;const t=y.selectedVenv||"default";e.info("Uninstalling ".concat(n," from ").concat(t,"..."));try{const{getRequestHeaders:r}=SillyTavern.getContext(),o=await fetch("".concat(y.serverUrl,"/uninstall"),{method:"POST",headers:a(a({},r()),{},{"Content-Type":"application/json"}),body:JSON.stringify({packages:n,venv:t})});if(!o.ok)throw new Error("Server error");const s=await o.json();if(s.error)e.error("Failed to uninstall ".concat(n,": ").concat(s.error));else{e.success("Uninstalled ".concat(n));const t=document.querySelector("#pyrunner_refresh_packages");t&&j(t)}}catch(t){console.error("[".concat(c,"] Uninstall error:"),t),e.error("Failed to uninstall ".concat(n,": ").concat(t.message))}}(e)}));const s=n=>{r.contains(n.target)||(r.remove(),document.removeEventListener("click",s))};setTimeout((()=>document.addEventListener("click",s)),0)}(e,n.dataset.package)}))}))}catch(n){console.error("[".concat(c,"] Package list error:"),n),e.innerHTML='<span class="pyrunner-hint">Error: '.concat(n.message,"</span>")}finally{n.innerHTML=t,n.disabled=!1}}let C=null;async function L(n){const e=document.querySelector("#pyrunner_log_content");if(!e)return;e.innerHTML='<span class="pyrunner-hint">Loading...</span>';const t=await async function(n){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;try{const{getRequestHeaders:t}=SillyTavern.getContext(),r="".concat(y.serverUrl,"/logs?file=").concat(encodeURIComponent(n),"&lines=").concat(e),o=await fetch(r,{method:"GET",headers:t()});if(!o.ok)throw new Error("Failed to fetch logs");return await o.json()}catch(n){return console.error("[".concat(c,"] Failed to fetch log content:"),n),{entries:[],error:n.message}}}(n,200);t.error?e.innerHTML='<span class="pyrunner-hint">Error: '.concat(t.error,"</span>"):t.entries&&0!==t.entries.length?(e.innerHTML=t.entries.map((n=>{let e="";return n.includes("[ERROR]")?e="error":n.includes("[WARN]")?e="warn":n.includes("[INFO]")?e="info":n.includes("[DEBUG]")&&(e="debug"),'<div class="pyrunner-log-entry '.concat(e,'">').concat(function(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}(n),"</div>")})).join(""),e.scrollTop=0):e.innerHTML='<span class="pyrunner-hint">No log entries found</span>'}async function q(n,e){var t;const r=window.toastr;if(!(n=null===(t=n)||void 0===t?void 0:t.trim()))return void r.warning("Please enter package names to install");const o=y.selectedVenv||"default",s=e.innerHTML;e.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Installing...',e.disabled=!0;try{const{getRequestHeaders:e}=SillyTavern.getContext(),t=await fetch("".concat(y.serverUrl,"/install"),{method:"POST",headers:a(a({},e()),{},{"Content-Type":"application/json"}),body:JSON.stringify({packages:n,venv:o})});if(!t.ok){const n=await t.text();throw new Error(n||"Server error")}const s=await t.json();var i;if(s.error)s.error.includes("already satisfied")||null!==(i=s.output)&&void 0!==i&&i.includes("already satisfied")?r.info("Package(s) already installed: ".concat(n)):r.error("Installation failed: ".concat(s.error));else s.output?s.output.includes("already satisfied")?r.info("Package(s) already installed: ".concat(n)):s.output.includes("Successfully installed")?r.success("Successfully installed: ".concat(n)):r.success("Installation complete: ".concat(n)):r.success("Installation complete: ".concat(n));const c=document.querySelector("#pyrunner_package_input");c&&(c.value="")}catch(n){console.error("[".concat(c,"] Package install error:"),n),r.error("Installation failed: ".concat(n.message))}finally{e.innerHTML=s,e.disabled=!1}}let N=null;function R(){const n=document.querySelector("#pyrunner_func_mode_select");return(null==n?void 0:n.value)||f()}function O(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const e=document.querySelector("#pyrunner_functions_list");if(!e)return;const t=g(y.functionScope||"character",R()),r=n?t.filter((e=>e.name.toLowerCase().includes(n.toLowerCase())||e.description&&e.description.toLowerCase().includes(n.toLowerCase()))):t;0!==r.length?(e.innerHTML=r.map((n=>'\n        <div class="pyrunner-function-item" data-name="'.concat(n.name,'">\n            <div class="pyrunner-function-info">\n                <div class="pyrunner-function-name">').concat(n.name,'</div>\n                <div class="pyrunner-function-desc">').concat(n.description||"(no description)",'</div>\n            </div>\n            <div class="pyrunner-function-actions">\n                <button class="menu_button menu_button_icon pyrunner-func-edit" data-name="').concat(n.name,'" title="Edit">\n                    <i class="fa-solid fa-pen"></i>\n                </button>\n                <button class="menu_button menu_button_icon pyrunner-func-delete" data-name="').concat(n.name,'" title="Delete">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        </div>\n    '))).join(""),e.querySelectorAll(".pyrunner-func-edit").forEach((n=>{n.addEventListener("click",(e=>{e.stopPropagation();const r=n.dataset.name,o=t.find((n=>n.name===r));o&&I(o)}))})),e.querySelectorAll(".pyrunner-func-delete").forEach((n=>{n.addEventListener("click",(e=>{e.stopPropagation();!function(n){const e=window.toastr;if(!confirm('Are you sure you want to delete the function "'.concat(n,'"?')))return;const t=R(),r=w(n,t);r.success?(e.success('Function "'.concat(n,'" deleted')),O(),V()):e.error(r.error)}(n.dataset.name)}))})),e.querySelectorAll(".pyrunner-function-item").forEach((n=>{n.addEventListener("click",(()=>{const e=n.dataset.name,r=t.find((n=>n.name===e));r&&I(r)}))}))):e.innerHTML='<span class="pyrunner-hint">No functions defined. Create one below.</span>'}function V(){const n=document.querySelector("#pyrunner_func_count_badge");n&&(n.textContent=S())}function I(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const e=document.querySelector("#pyrunner_func_modal"),t=document.querySelector("#pyrunner_modal_title"),r=document.querySelector("#pyrunner_func_name"),o=document.querySelector("#pyrunner_func_desc"),a=document.querySelector("#pyrunner_func_args"),s=document.querySelector("#pyrunner_func_code"),c=document.querySelector("#pyrunner_func_target");if(e){if(N=n?n.name:null,t&&(t.textContent=n?"Edit Function":"Create Function"),r&&(r.value=n?n.name:"",r.disabled=!!n),o&&(o.value=n&&n.description||""),a&&(a.value=n?(n.arguments||[]).join(", "):""),s&&(s.value=n?n.code:""),c){const n=y.functionScope||"character",e=R();c.textContent="".concat(n," / ").concat(e)}e.style.display="flex"}}function F(){const n=document.querySelector("#pyrunner_func_modal");n&&(n.style.display="none"),N=null}function M(){var n,e,t;const r=window.toastr,o=document.querySelector("#pyrunner_func_name"),a=document.querySelector("#pyrunner_func_desc"),s=document.querySelector("#pyrunner_func_args"),c=document.querySelector("#pyrunner_func_code"),i=null==o||null===(n=o.value)||void 0===n?void 0:n.trim(),l=(null==a||null===(e=a.value)||void 0===e?void 0:e.trim())||"",u=(null==s||null===(t=s.value)||void 0===t?void 0:t.trim())||"",d=_({name:i,description:l,code:(null==c?void 0:c.value)||"",arguments:u?u.split(",").map((n=>n.trim())).filter((n=>n)):[]},R());d.success?(r.success('Function "'.concat(i,'" saved successfully')),F(),O(),V()):r.error(d.error)}async function H(){const n=document.querySelector("#pyrunner_server_status");if(n)if("server"===y.executionMode)try{const e=await v.checkServerAvailable();n.textContent=e?"✓ Connected":"✗ Not available",n.className=e?"pyrunner-status-ok":"pyrunner-status-error"}catch(e){n.textContent="✗ Error",n.className="pyrunner-status-error"}else n.textContent="N/A",n.className="pyrunner-status-na"}i.on(l.APP_READY,(async function(){!function(){const n=SillyTavern.getContext();y=n.extensionSettings[c],y||(y=a({},d),n.extensionSettings[c]=y,u());for(const n in d)void 0===y[n]&&(y[n]=d[n]);y.functions||(y.functions={global:{},character:{}}),y.functions.global||(y.functions.global={}),y.functions.character||(y.functions.character={})}(),v=new r(y),window.SillyTavern||(window.SillyTavern={}),window.SillyTavern.PyRunner=v,function(){const{SlashCommand:n,SlashCommandParser:e,SlashCommandArgument:t,ARGUMENT_TYPE:r,SlashCommandNamedArgument:o}=SillyTavern.getContext();e.addCommandObject(n.fromProps({name:"pyrun",callback:async(n,e)=>{if(!y.enabled)return"Error: PyRunner is disabled. Enable it in the PyRunner panel.";let t=(null==e?void 0:e.toString())||"";if(!t.trim())return"Error: No Python code provided";const r=function(n){const e=y.functionScope||"character",t=y.functions[e]||{},r=f();let o="";const a=[];let s=null;const c=[r,...Object.keys(t).filter((n=>n!==r))];for(const e of c){const r=t[e]||[];for(const t of r)new RegExp("\\b".concat(t.name,"\\s*\\(")).test(n)&&!a.includes(t.name)&&(o+=t.code+"\n\n",a.push(t.name),null===s&&(s=e))}return{code:o?o+n:n,targetKey:s,injectedFunctions:a}}(t);t=r.code;let o=n.mode||y.executionMode,a=n.venv||y.selectedVenv;r.targetKey&&!n.venv&&("pyodide"===r.targetKey?o="pyodide":(o="server",a=r.targetKey));try{return await v.execute(t,{timeout:n.timeout?parseInt(n.timeout):y.timeout,mode:o,venv:a})}catch(n){return console.error("[".concat(c,"] Execution error:"),n),"Error: ".concat(n.message)}},namedArgumentList:[o.fromProps({name:"mode",description:'Execution mode: "pyodide" (browser) or "server" (local Python)',typeList:[r.STRING],enumList:["pyodide","server"],defaultValue:null}),o.fromProps({name:"timeout",description:"Execution timeout in milliseconds",typeList:[r.NUMBER],defaultValue:null}),o.fromProps({name:"venv",description:"Virtual environment to use (server mode only)",typeList:[r.STRING],defaultValue:null})],unnamedArgumentList:[t.fromProps({description:"Python code to execute",typeList:[r.STRING],isRequired:!0})],helpString:'\n            <div>\n                Executes Python code and returns the result.\n                <br><br>\n                <strong>Examples:</strong>\n                <ul>\n                    <li><code>/pyrun print("Hello, World!")</code></li>\n                    <li><code>/pyrun 2 + 2</code></li>\n                    <li><code>/pyrun mode=server import os; print(os.getcwd())</code></li>\n                    <li><code>/pyrun venv=myenv print("Using custom venv")</code></li>\n                </ul>\n                <br>\n                <strong>Modes:</strong>\n                <ul>\n                    <li><code>pyodide</code> - Runs in browser using WebAssembly (sandboxed, limited packages)</li>\n                    <li><code>server</code> - Runs on local machine via server plugin (full Python environment)</li>\n                </ul>\n                <br>\n                <strong>Venv:</strong> In server mode, uses the selected venv by default. Override with <code>venv=name</code>.\n            </div>\n        '})),console.log("[".concat(c,"] Slash command /pyrun registered")),e.addCommandObject(n.fromProps({name:"pyinstall",callback:async(n,e)=>{const t=(null==e?void 0:e.toString().trim())||"";if(!t)return"Error: No packages specified. Usage: /pyinstall numpy pandas";const r=n.venv||y.selectedVenv;try{const{getRequestHeaders:n}=SillyTavern.getContext(),e=await fetch("".concat(y.serverUrl,"/install"),{method:"POST",headers:a(a({},n()),{},{"Content-Type":"application/json"}),body:JSON.stringify({packages:t,venv:r})});if(!e.ok){const n=await e.text();throw new Error(n||"Server error")}const o=await e.json();return o.error?"Error: ".concat(o.error):o.output||"Packages installed successfully"}catch(n){return console.error("[".concat(c,"] Install error:"),n),"Error: ".concat(n.message)}},namedArgumentList:[o.fromProps({name:"venv",description:"Virtual environment to install packages into",typeList:[r.STRING],defaultValue:null})],unnamedArgumentList:[t.fromProps({description:"Package names to install (space-separated)",typeList:[r.STRING],isRequired:!0})],helpString:"\n            <div>\n                Installs Python packages using pip (server mode only).\n                <br><br>\n                <strong>Examples:</strong>\n                <ul>\n                    <li><code>/pyinstall numpy</code></li>\n                    <li><code>/pyinstall pandas matplotlib</code></li>\n                    <li><code>/pyinstall venv=myenv requests</code></li>\n                </ul>\n                <br>\n                Uses the selected venv by default. Override with <code>venv=name</code>.\n            </div>\n        "})),console.log("[".concat(c,"] Slash command /pyinstall registered")),e.addCommandObject(n.fromProps({name:"pyuninstall",callback:async(n,e)=>{const t=(null==e?void 0:e.toString().trim())||"";if(!t)return"Error: No packages specified. Usage: /pyuninstall numpy pandas";const r=n.venv||y.selectedVenv||"default";try{const{getRequestHeaders:n}=SillyTavern.getContext(),e=await fetch("".concat(y.serverUrl,"/uninstall"),{method:"POST",headers:a(a({},n()),{},{"Content-Type":"application/json"}),body:JSON.stringify({packages:t,venv:r})});if(!e.ok){const n=await e.text();throw new Error(n||"Server error")}const o=await e.json();return o.error?"Error: ".concat(o.error):o.output||"Packages uninstalled successfully"}catch(n){return console.error("[".concat(c,"] Uninstall error:"),n),"Error: ".concat(n.message)}},namedArgumentList:[o.fromProps({name:"venv",description:"Virtual environment to uninstall packages from",typeList:[r.STRING],defaultValue:null})],unnamedArgumentList:[t.fromProps({description:"Package names to uninstall (space-separated)",typeList:[r.STRING],isRequired:!0})],helpString:"\n            <div>\n                Uninstalls Python packages using pip (server mode only).\n                <br><br>\n                <strong>Examples:</strong>\n                <ul>\n                    <li><code>/pyuninstall numpy</code></li>\n                    <li><code>/pyuninstall pandas matplotlib</code></li>\n                    <li><code>/pyuninstall venv=myenv requests</code></li>\n                </ul>\n                <br>\n                Uses the selected venv by default. Override with <code>venv=name</code>.\n            </div>\n        "})),console.log("[".concat(c,"] Slash command /pyuninstall registered")),e.addCommandObject(n.fromProps({name:"pyvenv",callback:async(n,e)=>{const t=((null==e?void 0:e.toString().trim())||"").split(/\s+/).filter((n=>n));if(t.length>=2&&"create"===t[0].toLowerCase()){const n=t[1];if(!/^[a-zA-Z0-9]+$/.test(n))return"Error: Venv name must be alphanumeric only (no spaces or special characters)";try{const{getRequestHeaders:e}=SillyTavern.getContext(),t=await fetch("".concat(y.serverUrl,"/venvs"),{method:"POST",headers:a(a({},e()),{},{"Content-Type":"application/json"}),body:JSON.stringify({name:n})}),r=await t.json();return!t.ok||r.error?"Error: ".concat(r.error||"Failed to create venv"):(y.selectedVenv=n,u(),await E(),'Venv "'.concat(n,'" created and selected'))}catch(n){return console.error("[".concat(c,"] Create venv error:"),n),"Error: ".concat(n.message)}}if(t.length>=2&&"delete"===t[0].toLowerCase()){const n=t[1];if("default"===n)return"Error: Cannot delete the default venv";try{const{getRequestHeaders:e}=SillyTavern.getContext(),t=await fetch("".concat(y.serverUrl,"/venvs/").concat(encodeURIComponent(n)),{method:"DELETE",headers:e()}),r=await t.json();return!t.ok||r.error?"Error: ".concat(r.error||"Failed to delete venv"):(y.selectedVenv===n&&(y.selectedVenv="default",u()),await E(),'Venv "'.concat(n,'" deleted'))}catch(n){return console.error("[".concat(c,"] Delete venv error:"),n),"Error: ".concat(n.message)}}if(1===t.length){const n=t[0];try{const{getRequestHeaders:e}=SillyTavern.getContext(),t=await fetch("".concat(y.serverUrl,"/venvs"),{method:"GET",headers:e()}),r=(await t.json()).venvs||[];if(!r.includes(n))return'Error: Venv "'.concat(n,'" does not exist. Available: ').concat(r.join(", "));y.selectedVenv=n,u();const o=document.querySelector("#pyrunner_venv_select");return o&&(o.value=n),T(),'Venv "'.concat(n,'" selected')}catch(n){return console.error("[".concat(c,"] Select venv error:"),n),"Error: ".concat(n.message)}}try{const{getRequestHeaders:n}=SillyTavern.getContext(),e=await fetch("".concat(y.serverUrl,"/venvs"),{method:"GET",headers:n()}),t=(await e.json()).venvs||[],r=y.selectedVenv||"default";return"Current venv: ".concat(r,"\nAvailable: ").concat(t.join(", "))}catch(n){return"Current venv: ".concat(y.selectedVenv||"default","\nError fetching venv list: ").concat(n.message)}},unnamedArgumentList:[t.fromProps({description:'Venv name to select, or "create [name]" / "delete [name]"',typeList:[r.STRING],isRequired:!1})],helpString:'\n            <div>\n                Manages Python virtual environments (server mode only).\n                <br><br>\n                <strong>Usage:</strong>\n                <ul>\n                    <li><code>/pyvenv</code> - List available venvs and current selection</li>\n                    <li><code>/pyvenv [name]</code> - Select a venv</li>\n                    <li><code>/pyvenv create [name]</code> - Create a new venv</li>\n                    <li><code>/pyvenv delete [name]</code> - Delete a venv (not default)</li>\n                </ul>\n                <br>\n                <strong>Examples:</strong>\n                <ul>\n                    <li><code>/pyvenv myenv</code> - Switch to myenv</li>\n                    <li><code>/pyvenv create testing</code> - Create new venv called "testing"</li>\n                    <li><code>/pyvenv delete testing</code> - Delete the "testing" venv</li>\n                </ul>\n            </div>\n        '})),console.log("[".concat(c,"] Slash command /pyvenv registered")),e.addCommandObject(n.fromProps({name:"pycall",callback:async(n,e)=>{if(!y.enabled)return"Error: PyRunner is disabled. Enable it in the PyRunner panel.";const t=((null==e?void 0:e.toString().trim())||"").split(/\s+/),r=t[0];if(!r)return"Error: No function name provided. Usage: /pycall function_name [args]";const o=x(r);if(!o){const n=h().map((n=>n.name)).join(", ");return'Error: Function "'.concat(r,'" not found. Available: ').concat(n||"none")}const a=t.slice(1).join(", "),s="".concat(o.func.code,"\n\nresult = ").concat(r,"(").concat(a,")\nif result is not None:\n    print(result)");let i,l;"pyodide"===o.key?(i="pyodide",l="default"):(i="server",l=o.key);try{return await v.execute(s,{timeout:n.timeout?parseInt(n.timeout):y.timeout,mode:i,venv:l})}catch(n){return console.error("[".concat(c,"] Execution error:"),n),"Error: ".concat(n.message)}},namedArgumentList:[o.fromProps({name:"timeout",description:"Execution timeout in milliseconds",typeList:[r.NUMBER],defaultValue:null})],unnamedArgumentList:[t.fromProps({description:"Function name followed by arguments",typeList:[r.STRING],isRequired:!0})],helpString:"\n            <div>\n                Calls a saved function from the Functions Library.\n                <br><br>\n                <strong>Usage:</strong>\n                <ul>\n                    <li><code>/pycall function_name</code> - Call with no arguments</li>\n                    <li><code>/pycall function_name arg1 arg2</code> - Positional arguments</li>\n                    <li><code>/pycall function_name x=1 y=2</code> - Named arguments</li>\n                </ul>\n                <br>\n                <strong>Auto-venv:</strong> Functions automatically execute in the venv where they are stored.\n            </div>\n        "})),console.log("[".concat(c,"] Slash command /pycall registered")),e.addCommandObject(n.fromProps({name:"pyfunc",callback:async(n,e)=>{var t;const r=((null==e?void 0:e.toString().trim())||"").split(/\s+/).filter((n=>n)),o=null===(t=r[0])||void 0===t?void 0:t.toLowerCase();if(!o){const n=h(),e=f(),t=y.functionScope||"character";if(0===n.length)return"No functions in ".concat(t,"/").concat(e,". Create one with /pyfunc create or via the UI.");const r=n.map((n=>"  • ".concat(n.name).concat(n.description?" - ".concat(n.description):""))).join("\n");return"Functions in ".concat(t,"/").concat(e,":\n").concat(r)}if("create"===o)return"Use the PyRunner panel to create functions via the UI modal editor.";if("delete"===o){const n=r[1];if(!n)return"Error: No function name provided. Usage: /pyfunc delete function_name";const e=w(n);return e.success?'Function "'.concat(n,'" deleted successfully.'):"Error: ".concat(e.error)}if("scope"===o){var a;const n=null===(a=r[1])||void 0===a?void 0:a.toLowerCase();return n?"global"!==n&&"character"!==n?'Error: Scope must be "global" or "character"':(y.functionScope=n,u(),"Function scope set to: ".concat(n)):"Current scope: ".concat(y.functionScope||"character")}if("export"===o){const n=b(),e={scope:y.functionScope||"character",functions:n};return"```json\n"+JSON.stringify(e,null,2)+"\n```"}if("import"===o){const n=r.slice(1).join(" ");if(!n)return'Error: No JSON provided. Usage: /pyfunc import {"scope":"character","functions":{...}}';try{const e=JSON.parse(n),t=e.scope||y.functionScope||"character",r=e.functions||{};let o=0;for(const n of Object.keys(r)){const e=r[n]||[];for(const t of e){_(t,n).success&&o++}}return"Imported ".concat(o," function(s) to ").concat(t," scope.")}catch(n){return"Error parsing JSON: ".concat(n.message)}}if("info"===o){var s;const n=r[1];if(!n)return"Error: No function name provided. Usage: /pyfunc info function_name";const e=x(n);if(!e)return'Error: Function "'.concat(n,'" not found.');const t=e.func;return"Function: ".concat(t.name,"\nDescription: ").concat(t.description||"(none)","\nArguments: ").concat(null!==(s=t.arguments)&&void 0!==s&&s.length?t.arguments.join(", "):"(none)","\nStored in: ").concat(e.scope,"/").concat(e.key,"\n\nCode:\n```python\n").concat(t.code,"\n```")}return"Unknown subcommand: ".concat(o,". Available: create, delete, scope, export, import, info")},unnamedArgumentList:[t.fromProps({description:"Subcommand and arguments",typeList:[r.STRING],isRequired:!1})],helpString:"\n            <div>\n                Manages the Functions Library.\n                <br><br>\n                <strong>Usage:</strong>\n                <ul>\n                    <li><code>/pyfunc</code> - List all functions for current mode/venv</li>\n                    <li><code>/pyfunc create</code> - Opens the UI modal editor</li>\n                    <li><code>/pyfunc delete name</code> - Delete a function</li>\n                    <li><code>/pyfunc info name</code> - Show function details</li>\n                    <li><code>/pyfunc scope global|character</code> - Switch or view scope</li>\n                    <li><code>/pyfunc export</code> - Export all functions as JSON</li>\n                    <li><code>/pyfunc import {json}</code> - Import functions from JSON</li>\n                </ul>\n            </div>\n        "})),console.log("[".concat(c,"] Slash command /pyfunc registered"))}(),async function(){const n="server"===y.executionMode?await async function(){try{const{getRequestHeaders:n}=SillyTavern.getContext(),e=await fetch("".concat(y.serverUrl,"/logs/config"),{method:"GET",headers:n()});return e.ok?(C=await e.json(),C):null}catch(n){return console.error("[".concat(c,"] Failed to fetch log config:"),n),null}}():C,e=(SillyTavern.getContext().characters||[]).map(((n,e)=>({id:n.avatar||"char_".concat(e),name:n.name||"Character ".concat(e+1)}))),t=m(),r=function(n){var e,t,r;const{enabled:o,executionMode:a,timeout:s,selectedVenv:c,logConfig:i,functionScope:l,functionCount:u,selectedCharacter:d,characters:p}=n,y=null===(e=null==i?void 0:i.enabled)||void 0===e||e,v=null!==(t=null==i?void 0:i.directory)&&void 0!==t?t:"logs",f=null!=i&&i.maxFileSize?Math.round(i.maxFileSize/1048576):5,m=null!==(r=null==i?void 0:i.levels)&&void 0!==r?r:{ERROR:!0,WARN:!0,INFO:!0,DEBUG:!1};return'\n        <div class="pyrunner-panel">\n            <div class="pyrunner-panel-header">\n                <h2>PyRunner</h2>\n            </div>\n            <div class="pyrunner-panel-content">\n                <div class="pyrunner-settings-content">\n                    <div class="pyrunner-warning">\n                        <i class="fa-solid fa-triangle-exclamation"></i>\n                        <span>WARNING: USE AT YOUR OWN RISK</span>\n                    </div>\n\n                    <div class="pyrunner-toggle-row">\n                        <label for="pyrunner_enabled">Enable PyRunner</label>\n                        <input type="checkbox" id="pyrunner_enabled" '.concat(o?"checked":"",'>\n                    </div>\n\n                    \x3c!-- Execution Mode Section --\x3e\n                    <div class="pyrunner-collapsible">\n                        <div class="pyrunner-collapsible-header" data-target="pyrunner_section_mode">\n                            <i class="fa-solid fa-chevron-down pyrunner-collapse-icon"></i>\n                            <span>Execution Mode</span>\n                            <span class="pyrunner-section-badge" id="pyrunner_mode_badge">').concat(a,'</span>\n                        </div>\n                        <div class="pyrunner-collapsible-content" id="pyrunner_section_mode">\n                            <div class="pyrunner-radio-group">\n                                <label class="radio-label">\n                                    <input type="radio" name="pyrunner_mode" value="pyodide" ').concat("pyodide"===a?"checked":"",'>\n                                    <span>Pyodide (Browser)</span>\n                                    <small class="pyrunner-hint">Sandboxed, runs in WebAssembly. Limited to pure Python packages.</small>\n                                </label>\n                                <label class="radio-label">\n                                    <input type="radio" name="pyrunner_mode" value="server" ').concat("server"===a?"checked":"",'>\n                                    <span>Server (Local Python)</span>\n                                    <small class="pyrunner-hint">Requires server plugin. Full Python environment with all packages.</small>\n                                </label>\n                            </div>\n\n                            <div class="pyrunner-server-status-row">\n                                <label>Server Status:</label>\n                                <span id="pyrunner_server_status" class="pyrunner-status-na">N/A</span>\n                            </div>\n\n                            <div class="pyrunner-plugin-install">\n                                <button id="pyrunner_install_plugin" class="menu_button" title="Reinstall server plugin using Files API">\n                                    <i class="fa-solid fa-rotate"></i> Reinstall Plugin\n                                </button>\n                                <button id="pyrunner_copy_install_cmd" class="menu_button" title="Copy manual install instructions">\n                                    <i class="fa-solid fa-copy"></i> Manual\n                                </button>\n                            </div>\n                            <small class="pyrunner-hint">Reinstall if plugin is outdated. Restart after reinstall.</small>\n                        </div>\n                    </div>\n\n                    \x3c!-- Virtual Environments Section --\x3e\n                    <div class="pyrunner-collapsible">\n                        <div class="pyrunner-collapsible-header" data-target="pyrunner_section_venv">\n                            <i class="fa-solid fa-chevron-down pyrunner-collapse-icon"></i>\n                            <span>Virtual Environments</span>\n                            <span class="pyrunner-section-badge" id="pyrunner_venv_badge">').concat(c||"default",'</span>\n                        </div>\n                        <div class="pyrunner-collapsible-content" id="pyrunner_section_venv">\n                            <div class="pyrunner-venv-select-row">\n                                <select id="pyrunner_venv_select" class="text_pole">\n                                    <option value="default" ').concat("default"===c?"selected":"",'>default</option>\n                                </select>\n                                <button id="pyrunner_delete_venv" class="menu_button menu_button_icon" title="Delete selected venv" ').concat("default"===c?"disabled":"",'>\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                            <div class="pyrunner-venv-create-row">\n                                <input type="text" id="pyrunner_venv_name" class="text_pole" placeholder="New venv name (alphanumeric)">\n                                <button id="pyrunner_create_venv" class="menu_button">\n                                    <i class="fa-solid fa-plus"></i> Create\n                                </button>\n                            </div>\n                            <small class="pyrunner-hint">Server mode only. Select venv to manage its packages.</small>\n\n                            <hr class="pyrunner-section-divider">\n\n                            <label class="pyrunner-label">Packages</label>\n                            <div class="pyrunner-packages-input-row">\n                                <input type="text" id="pyrunner_package_input" class="text_pole" placeholder="e.g. numpy pandas requests">\n                                <button id="pyrunner_install_packages" class="menu_button">\n                                    <i class="fa-solid fa-download"></i> Install\n                                </button>\n                            </div>\n                            <small class="pyrunner-hint">Space-separated package names. Uses pip.</small>\n\n                            <div class="pyrunner-packages-list-header">\n                                <label class="pyrunner-label">Installed Packages</label>\n                                <button id="pyrunner_refresh_packages" class="menu_button menu_button_icon" title="Refresh package list">\n                                    <i class="fa-solid fa-refresh"></i>\n                                </button>\n                            </div>\n                            <div id="pyrunner_packages_list" class="pyrunner-packages-list">\n                                <span class="pyrunner-hint">Click refresh to load packages</span>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Functions Library Section --\x3e\n                    <div class="pyrunner-collapsible">\n                        <div class="pyrunner-collapsible-header" data-target="pyrunner_section_functions">\n                            <i class="fa-solid fa-chevron-down pyrunner-collapse-icon"></i>\n                            <span>Functions Library</span>\n                            <span class="pyrunner-section-badge" id="pyrunner_func_count_badge">').concat(u||0,'</span>\n                        </div>\n                        <div class="pyrunner-collapsible-content" id="pyrunner_section_functions">\n                            <div class="pyrunner-func-scope-row">\n                                <label>Scope:</label>\n                                <div class="pyrunner-func-scope-toggle">\n                                    <button id="pyrunner_scope_character" class="menu_button ').concat("global"!==l?"menu_button_selected":"",'" data-scope="character">\n                                        <i class="fa-solid fa-user"></i> Character\n                                    </button>\n                                    <button id="pyrunner_scope_global" class="menu_button ').concat("global"===l?"menu_button_selected":"",'" data-scope="global">\n                                        <i class="fa-solid fa-globe"></i> Global\n                                    </button>\n                                </div>\n                            </div>\n\n                            <div class="pyrunner-func-character-row" style="display: ').concat("global"!==l?"flex":"none",';">\n                                <label>Character:</label>\n                                <select id="pyrunner_func_character_select" class="text_pole">\n                                    ').concat(p&&p.length>0?p.map((n=>'<option value="'.concat(n.id,'" ').concat(d===n.id?"selected":"",">").concat(n.name,"</option>"))).join(""):'<option value="">No characters available</option>','\n                                </select>\n                            </div>\n\n                            <div class="pyrunner-func-mode-row">\n                                <label>Mode/Venv:</label>\n                                <select id="pyrunner_func_mode_select" class="text_pole">\n                                    <option value="pyodide" ').concat("pyodide"===a?"selected":"",'>Pyodide</option>\n                                    <option value="').concat(c||"default",'" ').concat("server"===a?"selected":"",">").concat(c||"default",'</option>\n                                </select>\n                            </div>\n\n                            <div class="pyrunner-func-search-row">\n                                <input type="text" id="pyrunner_func_search" class="text_pole" placeholder="Search functions...">\n                            </div>\n\n                            <div id="pyrunner_functions_list" class="pyrunner-functions-list">\n                                <span class="pyrunner-hint">No functions defined. Create one below.</span>\n                            </div>\n\n                            <button id="pyrunner_create_function" class="menu_button pyrunner-create-func-btn">\n                                <i class="fa-solid fa-plus"></i> Create Function\n                            </button>\n\n                            <small class="pyrunner-hint">Reusable Python code snippets. Use with /pycall or inline in /pyrun.</small>\n                        </div>\n                    </div>\n\n                    \x3c!-- Function Editor Modal --\x3e\n                    <div id="pyrunner_func_modal" class="pyrunner-modal-overlay" style="display: none;">\n                        <div class="pyrunner-modal-dialog">\n                            <div class="pyrunner-modal-header">\n                                <h3 id="pyrunner_modal_title">Create Function</h3>\n                                <button id="pyrunner_modal_close" class="menu_button menu_button_icon" title="Close">\n                                    <i class="fa-solid fa-times"></i>\n                                </button>\n                            </div>\n                            <div class="pyrunner-modal-body">\n                                <div class="pyrunner-modal-row">\n                                    <label for="pyrunner_func_name">Name:</label>\n                                    <input type="text" id="pyrunner_func_name" class="text_pole" placeholder="my_function">\n                                </div>\n                                <div class="pyrunner-modal-row">\n                                    <label for="pyrunner_func_desc">Description:</label>\n                                    <input type="text" id="pyrunner_func_desc" class="text_pole" placeholder="What this function does...">\n                                </div>\n                                <div class="pyrunner-modal-row">\n                                    <label for="pyrunner_func_args">Arguments:</label>\n                                    <input type="text" id="pyrunner_func_args" class="text_pole" placeholder="arg1, arg2 (comma-separated, optional)">\n                                </div>\n                                <div class="pyrunner-modal-row pyrunner-modal-code-row">\n                                    <label for="pyrunner_func_code">Code:</label>\n                                    <textarea id="pyrunner_func_code" class="text_pole pyrunner-code-editor" placeholder="def my_function(arg1, arg2):&#10;    # Your Python code here&#10;    return result"></textarea>\n                                </div>\n                                <div class="pyrunner-modal-row">\n                                    <label>Target:</label>\n                                    <span id="pyrunner_func_target" class="pyrunner-func-target">character / pyodide</span>\n                                </div>\n                            </div>\n                            <div class="pyrunner-modal-footer">\n                                <button id="pyrunner_modal_cancel" class="menu_button">Cancel</button>\n                                <button id="pyrunner_modal_save" class="menu_button menu_button_primary">\n                                    <i class="fa-solid fa-save"></i> Save Function\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Logging Section --\x3e\n                    <div class="pyrunner-collapsible">\n                        <div class="pyrunner-collapsible-header" data-target="pyrunner_section_logging">\n                            <i class="fa-solid fa-chevron-down pyrunner-collapse-icon"></i>\n                            <span>Logging</span>\n                            <span class="pyrunner-section-badge ').concat(y?"pyrunner-badge-on":"pyrunner-badge-off",'">').concat(y?"ON":"OFF",'</span>\n                        </div>\n                        <div class="pyrunner-collapsible-content" id="pyrunner_section_logging">\n                            <div class="pyrunner-logging-toggle">\n                                <label class="pyrunner-toggle-inline">\n                                    <input type="checkbox" id="pyrunner_log_enabled" ').concat(y?"checked":"",'>\n                                    <span>Enable Logging</span>\n                                </label>\n                            </div>\n\n                            <div class="pyrunner-log-row">\n                                <label for="pyrunner_log_directory">Log Directory:</label>\n                                <input type="text" id="pyrunner_log_directory" class="text_pole" value="').concat(v,'" placeholder="logs">\n                            </div>\n\n                            <div class="pyrunner-log-row">\n                                <label for="pyrunner_log_max_size">Max File Size (MB):</label>\n                                <input type="number" id="pyrunner_log_max_size" class="text_pole" value="').concat(f,'" min="1" max="100" step="1">\n                            </div>\n\n                            <label class="pyrunner-label">Log Levels:</label>\n                            <div class="pyrunner-log-levels">\n                                <label class="pyrunner-checkbox-label">\n                                    <input type="checkbox" id="pyrunner_log_error" ').concat(m.ERROR?"checked":"",'>\n                                    <span class="pyrunner-level-error">ERROR</span>\n                                    <small>Script failures, system errors</small>\n                                </label>\n                                <label class="pyrunner-checkbox-label">\n                                    <input type="checkbox" id="pyrunner_log_warn" ').concat(m.WARN?"checked":"",'>\n                                    <span class="pyrunner-level-warn">WARN</span>\n                                    <small>Warnings, timeouts</small>\n                                </label>\n                                <label class="pyrunner-checkbox-label">\n                                    <input type="checkbox" id="pyrunner_log_info" ').concat(m.INFO?"checked":"",'>\n                                    <span class="pyrunner-level-info">INFO</span>\n                                    <small>Normal operations</small>\n                                </label>\n                                <label class="pyrunner-checkbox-label">\n                                    <input type="checkbox" id="pyrunner_log_debug" ').concat(m.DEBUG?"checked":"",'>\n                                    <span class="pyrunner-level-debug">DEBUG</span>\n                                    <small>Detailed debugging</small>\n                                </label>\n                            </div>\n\n                            <div class="pyrunner-log-actions">\n                                <button id="pyrunner_save_log_config" class="menu_button">\n                                    <i class="fa-solid fa-save"></i> Save Config\n                                </button>\n                                <button id="pyrunner_view_logs" class="menu_button">\n                                    <i class="fa-solid fa-file-lines"></i> View Logs\n                                </button>\n                            </div>\n\n                            <div id="pyrunner_log_viewer" class="pyrunner-log-viewer" style="display: none;">\n                                <div class="pyrunner-log-viewer-header">\n                                    <select id="pyrunner_log_file_select" class="text_pole"></select>\n                                    <button id="pyrunner_refresh_logs" class="menu_button menu_button_icon" title="Refresh logs">\n                                        <i class="fa-solid fa-refresh"></i>\n                                    </button>\n                                    <button id="pyrunner_close_log_viewer" class="menu_button menu_button_icon" title="Close">\n                                        <i class="fa-solid fa-times"></i>\n                                    </button>\n                                </div>\n                                <div id="pyrunner_log_content" class="pyrunner-log-content">\n                                    <span class="pyrunner-hint">Select a log file to view</span>\n                                </div>\n                            </div>\n\n                            <small class="pyrunner-hint">Server mode only. Logs script executions and errors.</small>\n                        </div>\n                    </div>\n\n                    \x3c!-- Settings Section --\x3e\n                    <div class="pyrunner-collapsible">\n                        <div class="pyrunner-collapsible-header" data-target="pyrunner_section_settings">\n                            <i class="fa-solid fa-chevron-down pyrunner-collapse-icon"></i>\n                            <span>Settings</span>\n                        </div>\n                        <div class="pyrunner-collapsible-content" id="pyrunner_section_settings">\n                            <label class="pyrunner-label" for="pyrunner_timeout">Timeout (ms)</label>\n                            <input type="number" id="pyrunner_timeout" class="text_pole" value="').concat(s,'" min="1000" max="300000" step="1000">\n                            <small class="pyrunner-hint">Maximum execution time before timeout (1000-300000 ms)</small>\n                        </div>\n                    </div>\n\n                    \x3c!-- Help Section --\x3e\n                    <div class="pyrunner-collapsible">\n                        <div class="pyrunner-collapsible-header" data-target="pyrunner_section_help">\n                            <i class="fa-solid fa-chevron-down pyrunner-collapse-icon"></i>\n                            <span>Help</span>\n                        </div>\n                        <div class="pyrunner-collapsible-content" id="pyrunner_section_help">\n                            <div class="pyrunner-help">\n                                <div class="pyrunner-help-title">Commands:</div>\n                                <ul>\n                                    <li><code>/pyrun &lt;code&gt;</code> - Execute Python code</li>\n                                    <li><code>/pycall &lt;func&gt; [args]</code> - Call saved function</li>\n                                    <li><code>/pyfunc [subcommand]</code> - Manage functions</li>\n                                    <li><code>/pyinstall &lt;packages&gt;</code> - Install packages</li>\n                                    <li><code>/pyuninstall &lt;packages&gt;</code> - Uninstall packages</li>\n                                    <li><code>/pyvenv [name|create|delete]</code> - Manage venvs</li>\n                                </ul>\n                                <br>\n                                <div class="pyrunner-help-title">Examples:</div>\n                                <ul>\n                                    <li><code>/pyrun print("Hello!")</code></li>\n                                    <li><code>/pyrun my_func()</code> - Calls saved function inline</li>\n                                    <li><code>/pycall roll_dice 20</code></li>\n                                    <li><code>/pyfunc info my_func</code></li>\n                                    <li><code>/pyinstall venv=myenv numpy pandas</code></li>\n                                </ul>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            .pyrunner-panel {\n                display: flex;\n                flex-direction: column;\n                height: 100%;\n            }\n\n            .pyrunner-panel-header {\n                padding: 10px 15px;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n            }\n\n            .pyrunner-panel-header h2 {\n                margin: 0;\n                font-size: 1.2em;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .pyrunner-panel-content {\n                flex: 1;\n                overflow-y: auto;\n                padding: 10px 15px;\n            }\n\n            .pyrunner-settings-content {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .pyrunner-warning {\n                background: #8b0000;\n                color: #fff;\n                padding: 8px 12px;\n                border-radius: 5px;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                font-weight: bold;\n                font-size: 0.9em;\n            }\n\n            .pyrunner-warning i {\n                font-size: 1.1em;\n            }\n\n            .pyrunner-toggle-row {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 5px 0;\n            }\n\n            .pyrunner-toggle-row label {\n                font-weight: bold;\n            }\n\n            /* Collapsible Sections */\n            .pyrunner-collapsible {\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 5px;\n                overflow: hidden;\n            }\n\n            .pyrunner-collapsible-header {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 8px 12px;\n                background: rgba(0, 0, 0, 0.2);\n                cursor: pointer;\n                user-select: none;\n                font-weight: bold;\n                font-size: 0.95em;\n            }\n\n            .pyrunner-collapsible-header:hover {\n                background: rgba(0, 0, 0, 0.3);\n            }\n\n            .pyrunner-collapse-icon {\n                font-size: 0.8em;\n                transition: transform 0.2s;\n                width: 12px;\n            }\n\n            .pyrunner-collapsible-header.collapsed .pyrunner-collapse-icon {\n                transform: rotate(-90deg);\n            }\n\n            .pyrunner-section-badge {\n                margin-left: auto;\n                padding: 2px 8px;\n                border-radius: 10px;\n                font-size: 0.75em;\n                font-weight: normal;\n                background: rgba(255, 255, 255, 0.15);\n            }\n\n            .pyrunner-badge-on {\n                background: rgba(76, 175, 80, 0.3);\n                color: #4caf50;\n            }\n\n            .pyrunner-badge-off {\n                background: rgba(158, 158, 158, 0.3);\n                color: #9e9e9e;\n            }\n\n            .pyrunner-collapsible-content {\n                padding: 10px 12px;\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .pyrunner-collapsible-content.collapsed {\n                display: none;\n            }\n\n            .pyrunner-section-divider {\n                border: none;\n                border-top: 1px solid var(--SmartThemeBorderColor, #444);\n                margin: 10px 0;\n            }\n\n            .pyrunner-label {\n                font-weight: bold;\n                margin-top: 5px;\n                font-size: 0.9em;\n            }\n\n            .pyrunner-radio-group {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .pyrunner-radio-group .radio-label {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n                cursor: pointer;\n            }\n\n            .pyrunner-radio-group .radio-label > span {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n            }\n\n            .pyrunner-radio-group input[type="radio"] {\n                margin-right: 5px;\n            }\n\n            .pyrunner-hint {\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.7;\n                font-size: 0.8em;\n                margin-left: 20px;\n            }\n\n            .pyrunner-server-status-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                margin: 5px 0;\n                font-size: 0.9em;\n            }\n\n            .pyrunner-status-ok {\n                color: #4caf50;\n                font-weight: bold;\n            }\n\n            .pyrunner-status-error {\n                color: #f44336;\n                font-weight: bold;\n            }\n\n            .pyrunner-status-na {\n                opacity: 0.7;\n            }\n\n            .pyrunner-help {\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 5px;\n                font-size: 0.85em;\n            }\n\n            .pyrunner-help-title {\n                font-weight: bold;\n                margin-bottom: 5px;\n            }\n\n            .pyrunner-help code {\n                background: rgba(0, 0, 0, 0.3);\n                color: inherit;\n                padding: 2px 6px;\n                border-radius: 3px;\n                font-family: monospace;\n                font-size: 0.9em;\n            }\n\n            .pyrunner-help ul {\n                margin: 5px 0;\n                padding-left: 20px;\n            }\n\n            .pyrunner-help li {\n                margin: 3px 0;\n            }\n\n            .pyrunner-plugin-install {\n                display: flex;\n                gap: 8px;\n                flex-wrap: wrap;\n                margin: 5px 0;\n            }\n\n            .pyrunner-plugin-install .menu_button {\n                display: inline-flex;\n                align-items: center;\n                gap: 5px;\n                text-decoration: none;\n                font-size: 0.85em;\n            }\n\n            .pyrunner-venv-select-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n\n            .pyrunner-venv-select-row select {\n                flex: 1;\n            }\n\n            .pyrunner-venv-select-row .menu_button_icon {\n                padding: 5px 10px;\n                min-width: unset;\n            }\n\n            .pyrunner-venv-create-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n\n            .pyrunner-venv-create-row input {\n                flex: 1;\n            }\n\n            .pyrunner-packages-input-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n\n            .pyrunner-packages-input-row input {\n                flex: 1;\n            }\n\n            .pyrunner-packages-input-row .menu_button {\n                display: inline-flex;\n                align-items: center;\n                gap: 5px;\n                white-space: nowrap;\n                font-size: 0.85em;\n            }\n\n            .pyrunner-packages-list-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                margin-top: 5px;\n            }\n\n            .pyrunner-packages-list-header .menu_button_icon {\n                padding: 3px 8px;\n                min-width: unset;\n            }\n\n            .pyrunner-packages-list {\n                max-height: 120px;\n                overflow-y: auto;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                padding: 8px;\n                font-size: 0.8em;\n            }\n\n            .pyrunner-package-item {\n                display: inline-block;\n                background: rgba(0, 0, 0, 0.3);\n                padding: 2px 8px;\n                border-radius: 3px;\n                margin: 2px;\n                cursor: pointer;\n                transition: background 0.2s;\n            }\n\n            .pyrunner-package-version {\n                opacity: 0.7;\n                margin-left: 3px;\n            }\n\n            .pyrunner-package-item:hover {\n                background: rgba(255, 255, 255, 0.1);\n            }\n\n            .pyrunner-package-popup {\n                position: fixed;\n                background: var(--SmartThemeBlurTintColor, #333);\n                border: 1px solid var(--SmartThemeBorderColor, #555);\n                border-radius: 5px;\n                padding: 5px 0;\n                z-index: 10000;\n                box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n                min-width: 120px;\n            }\n\n            .pyrunner-package-popup-item {\n                padding: 8px 15px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .pyrunner-package-popup-item:hover {\n                background: rgba(255, 255, 255, 0.1);\n            }\n\n            .pyrunner-package-popup-item.danger {\n                color: #f44336;\n            }\n\n            .pyrunner-package-popup-item.danger:hover {\n                background: rgba(244, 67, 54, 0.2);\n            }\n\n            /* Logging Section Styles */\n            .pyrunner-logging-toggle {\n                margin-bottom: 5px;\n            }\n\n            .pyrunner-toggle-inline {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n                cursor: pointer;\n            }\n\n            .pyrunner-log-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .pyrunner-log-row label {\n                min-width: 110px;\n                font-size: 0.85em;\n            }\n\n            .pyrunner-log-row input {\n                flex: 1;\n                max-width: 180px;\n            }\n\n            .pyrunner-log-levels {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n                margin-left: 5px;\n            }\n\n            .pyrunner-checkbox-label {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                cursor: pointer;\n                font-size: 0.85em;\n            }\n\n            .pyrunner-checkbox-label small {\n                opacity: 0.7;\n                font-size: 0.9em;\n            }\n\n            .pyrunner-level-error {\n                color: #f44336;\n                font-weight: bold;\n                min-width: 50px;\n            }\n\n            .pyrunner-level-warn {\n                color: #ff9800;\n                font-weight: bold;\n                min-width: 50px;\n            }\n\n            .pyrunner-level-info {\n                color: #2196f3;\n                font-weight: bold;\n                min-width: 50px;\n            }\n\n            .pyrunner-level-debug {\n                color: #9e9e9e;\n                font-weight: bold;\n                min-width: 50px;\n            }\n\n            .pyrunner-log-actions {\n                display: flex;\n                gap: 8px;\n                margin-top: 5px;\n            }\n\n            .pyrunner-log-actions .menu_button {\n                font-size: 0.85em;\n            }\n\n            .pyrunner-log-viewer {\n                margin-top: 8px;\n                border: 1px solid var(--SmartThemeBorderColor, #555);\n                border-radius: 5px;\n                overflow: hidden;\n            }\n\n            .pyrunner-log-viewer-header {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n                padding: 5px;\n                background: rgba(0, 0, 0, 0.2);\n            }\n\n            .pyrunner-log-viewer-header select {\n                flex: 1;\n            }\n\n            .pyrunner-log-content {\n                max-height: 200px;\n                overflow-y: auto;\n                padding: 8px;\n                background: rgba(0, 0, 0, 0.3);\n                font-family: monospace;\n                font-size: 0.75em;\n                white-space: pre-wrap;\n                word-break: break-all;\n            }\n\n            .pyrunner-log-entry {\n                padding: 2px 0;\n                border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            }\n\n            .pyrunner-log-entry:last-child {\n                border-bottom: none;\n            }\n\n            .pyrunner-log-entry.error {\n                color: #f44336;\n            }\n\n            .pyrunner-log-entry.warn {\n                color: #ff9800;\n            }\n\n            .pyrunner-log-entry.info {\n                color: #2196f3;\n            }\n\n            .pyrunner-log-entry.debug {\n                color: #9e9e9e;\n            }\n\n            /* Functions Library Section */\n            .pyrunner-func-scope-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .pyrunner-func-scope-row > label {\n                font-size: 0.85em;\n                min-width: 50px;\n            }\n\n            .pyrunner-func-scope-toggle {\n                display: flex;\n                gap: 5px;\n                flex: 1;\n            }\n\n            .pyrunner-func-scope-toggle .menu_button {\n                flex: 1;\n                display: inline-flex;\n                align-items: center;\n                justify-content: center;\n                gap: 5px;\n                font-size: 0.8em;\n                padding: 5px 10px;\n            }\n\n            .pyrunner-func-scope-toggle .menu_button_selected {\n                background: var(--SmartThemeQuoteColor, #4a7c59);\n                border-color: var(--SmartThemeQuoteColor, #4a7c59);\n            }\n\n            .pyrunner-func-character-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .pyrunner-func-character-row > label {\n                font-size: 0.85em;\n                min-width: 70px;\n            }\n\n            .pyrunner-func-character-row select {\n                flex: 1;\n            }\n\n            .pyrunner-func-mode-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .pyrunner-func-mode-row > label {\n                font-size: 0.85em;\n                min-width: 70px;\n            }\n\n            .pyrunner-func-mode-row select {\n                flex: 1;\n            }\n\n            .pyrunner-func-search-row {\n                margin-top: 5px;\n            }\n\n            .pyrunner-func-search-row input {\n                width: 100%;\n            }\n\n            .pyrunner-functions-list {\n                max-height: 150px;\n                overflow-y: auto;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                padding: 8px;\n                min-height: 60px;\n            }\n\n            .pyrunner-function-item {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 6px 8px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 4px;\n                margin-bottom: 4px;\n                cursor: pointer;\n                transition: background 0.2s;\n            }\n\n            .pyrunner-function-item:last-child {\n                margin-bottom: 0;\n            }\n\n            .pyrunner-function-item:hover {\n                background: rgba(255, 255, 255, 0.1);\n            }\n\n            .pyrunner-function-info {\n                flex: 1;\n                min-width: 0;\n            }\n\n            .pyrunner-function-name {\n                font-weight: bold;\n                font-size: 0.9em;\n                color: var(--SmartThemeQuoteColor, #4a7c59);\n            }\n\n            .pyrunner-function-desc {\n                font-size: 0.75em;\n                opacity: 0.7;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n\n            .pyrunner-function-actions {\n                display: flex;\n                gap: 4px;\n                margin-left: 8px;\n            }\n\n            .pyrunner-function-actions .menu_button_icon {\n                padding: 3px 6px;\n                min-width: unset;\n                font-size: 0.8em;\n            }\n\n            .pyrunner-create-func-btn {\n                width: 100%;\n                margin-top: 5px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 5px;\n            }\n\n            /* Modal Styles */\n            .pyrunner-modal-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0, 0, 0, 0.7);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10001;\n            }\n\n            .pyrunner-modal-dialog {\n                background: var(--SmartThemeBlurTintColor, #1a1a1a);\n                border: 1px solid var(--SmartThemeBorderColor, #555);\n                border-radius: 10px;\n                width: 90%;\n                max-width: 500px;\n                max-height: 90vh;\n                display: flex;\n                flex-direction: column;\n                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);\n            }\n\n            .pyrunner-modal-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 12px 15px;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n            }\n\n            .pyrunner-modal-header h3 {\n                margin: 0;\n                font-size: 1.1em;\n            }\n\n            .pyrunner-modal-body {\n                padding: 15px;\n                overflow-y: auto;\n                flex: 1;\n            }\n\n            .pyrunner-modal-row {\n                margin-bottom: 12px;\n            }\n\n            .pyrunner-modal-row:last-child {\n                margin-bottom: 0;\n            }\n\n            .pyrunner-modal-row > label {\n                display: block;\n                font-weight: bold;\n                font-size: 0.85em;\n                margin-bottom: 4px;\n            }\n\n            .pyrunner-modal-row input,\n            .pyrunner-modal-row textarea {\n                width: 100%;\n            }\n\n            .pyrunner-modal-code-row {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n            }\n\n            .pyrunner-code-editor {\n                min-height: 150px;\n                font-family: monospace;\n                font-size: 0.85em;\n                resize: vertical;\n                white-space: pre;\n                tab-size: 4;\n            }\n\n            .pyrunner-func-target {\n                font-size: 0.85em;\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 4px;\n                display: inline-block;\n            }\n\n            .pyrunner-modal-footer {\n                display: flex;\n                justify-content: flex-end;\n                gap: 10px;\n                padding: 12px 15px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #555);\n            }\n\n            .pyrunner-modal-footer .menu_button_primary {\n                background: var(--SmartThemeQuoteColor, #4a7c59);\n            }\n        </style>\n    ')}({enabled:y.enabled,executionMode:y.executionMode,timeout:y.timeout,selectedVenv:y.selectedVenv,logConfig:n,functionScope:y.functionScope,functionCount:S(),selectedCharacter:t,characters:e}),o=document.createElement("div");o.id="pyrunner-button",o.className="drawer",o.innerHTML='\n        <div class="drawer-toggle drawer-header">\n            <div class="drawer-icon fa-solid fa-microchip fa-fw closedIcon" title="PyRunner"></div>\n        </div>\n        <div id="pyrunner_drawer" class="drawer-content closedDrawer">\n            '.concat(r,"\n        </div>\n    ");const s=document.getElementById("extensions-settings-button");s&&s.after(o);const i=document.querySelector("#extensions-settings-button .drawer-toggle");if(i&&window.jQuery){const n=window.jQuery,e=n._data(i,"events");if(e&&e.click&&e.click[0]){const t=e.click[0].handler;n("#pyrunner-button .drawer-toggle").on("click",t)}}const l=o.querySelector("#pyrunner_drawer"),p=l.querySelector("#pyrunner_enabled");p&&p.addEventListener("change",(n=>{y.enabled=n.target.checked,u()}));l.querySelectorAll('input[name="pyrunner_mode"]').forEach((n=>{n.addEventListener("change",(n=>{y.executionMode=n.target.value,v.setMode(n.target.value),u(),H(),"server"===n.target.value&&E()}))}));const f=l.querySelector("#pyrunner_timeout");f&&f.addEventListener("change",(n=>{y.timeout=parseInt(n.target.value)||d.timeout,u()}));const g=l.querySelector("#pyrunner_install_plugin");g&&g.addEventListener("click",(async()=>{await async function(n){const e=n.innerHTML;n.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Installing...',n.disabled=!0;try{const e=await async function(n,e){try{const t=await fetch("/api/plugins/files/put",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:n,text:e,overwrite:!0})});if(t.ok){const n=await t.json();if(!1!==n.ok)return{ok:!0};if(n.error)return{ok:!1,error:n.error}}}catch(n){}try{const t=await fetch("/api/plugins/files-v2/put",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:n,text:e,overwrite:!0})});if(t.ok){const n=await t.json();if(!1!==n.ok)return{ok:!0};if(n.error)return{ok:!1,error:n.error}}}catch(n){}return{ok:!1,error:"Files plugin not available. Please install LennySuite Files plugin first."}}("plugins/pyrunner/index.js",k);if(!e.ok)throw new Error(e.error||"Failed to write plugin file");n.innerHTML='<i class="fa-solid fa-check"></i> Installed!',alert("Server plugin installed successfully!\\n\\nPlease restart SillyTavern and enable server plugins in config.yaml:\\n\\nenableServerPlugins: true")}catch(e){console.error("[PyRunner] Install error:",e),n.innerHTML='<i class="fa-solid fa-times"></i> Failed',alert("Installation failed: "+e.message)}finally{setTimeout((()=>{n.innerHTML=e,n.disabled=!1}),3e3)}}(g)}));const h=l.querySelector("#pyrunner_copy_install_cmd");h&&h.addEventListener("click",(async()=>{const n="Copy the server-plugin/index.js file to SillyTavern/plugins/pyrunner/index.js";try{await navigator.clipboard.writeText(n);const e=h.innerHTML;h.innerHTML='<i class="fa-solid fa-check"></i> Copied!',setTimeout((()=>{h.innerHTML=e}),2e3)}catch(e){console.error("Failed to copy:",e),alert("Install instructions:\n\n"+n)}}));const b=l.querySelector("#pyrunner_install_packages"),x=l.querySelector("#pyrunner_package_input");b&&x&&(b.addEventListener("click",(async()=>{await q(x.value,b)})),x.addEventListener("keypress",(async n=>{"Enter"===n.key&&await q(x.value,b)})));const _=l.querySelector("#pyrunner_refresh_packages");_&&_.addEventListener("click",(async()=>{await j(_)}));const w=l.querySelector("#pyrunner_venv_select");w&&w.addEventListener("change",(async n=>{y.selectedVenv=n.target.value,u(),T(),_&&await j(_)}));const N=l.querySelector("#pyrunner_create_venv");N&&N.addEventListener("click",(async()=>{await P()}));const R=l.querySelector("#pyrunner_venv_name");R&&R.addEventListener("keypress",(async n=>{"Enter"===n.key&&await P()}));const U=l.querySelector("#pyrunner_delete_venv");U&&U.addEventListener("click",(async()=>{await async function(){const n=window.toastr,e=y.selectedVenv;if(!e||"default"===e)return void n.error("Cannot delete the default venv");if(!confirm('Are you sure you want to delete venv "'.concat(e,'"? All installed packages will be lost.')))return;const t=document.querySelector("#pyrunner_delete_venv");t&&(t.disabled=!0,t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>');try{const{getRequestHeaders:t}=SillyTavern.getContext(),r=await fetch("".concat(y.serverUrl,"/venvs/").concat(encodeURIComponent(e)),{method:"DELETE",headers:t()}),o=await r.json();if(!r.ok||o.error)return void n.error(o.error||"Failed to delete venv");n.success('Venv "'.concat(e,'" deleted successfully')),y.selectedVenv="default",u(),await E();const a=document.querySelector("#pyrunner_refresh_packages");a&&await j(a)}catch(e){console.error("[".concat(c,"] Delete venv error:"),e),n.error("Failed to delete venv: ".concat(e.message))}finally{t&&(t.disabled=!1,t.innerHTML='<i class="fa-solid fa-trash"></i> Delete'),T()}}()}));l.querySelectorAll(".pyrunner-collapsible-header").forEach((n=>{n.addEventListener("click",(()=>{const e=n.dataset.target,t=document.getElementById(e);t&&(n.classList.toggle("collapsed"),t.classList.toggle("collapsed"))}))}));["pyrunner_section_mode","pyrunner_section_venv","pyrunner_section_functions","pyrunner_section_logging","pyrunner_section_settings","pyrunner_section_help"].forEach((n=>{const e=document.getElementById(n),t=l.querySelector('[data-target="'.concat(n,'"]'));e&&t&&(e.classList.add("collapsed"),t.classList.add("collapsed"))}));const A=l.querySelector("#pyrunner_save_log_config");A&&A.addEventListener("click",(async()=>{await async function(){var n,e,t,r,o,s,i,l,u,d,p,v;const f=window.toastr,m=null===(n=null===(e=document.querySelector("#pyrunner_log_enabled"))||void 0===e?void 0:e.checked)||void 0===n||n,g=(null===(t=document.querySelector("#pyrunner_log_directory"))||void 0===t?void 0:t.value)||"logs",h=1024*(parseInt(null===(r=document.querySelector("#pyrunner_log_max_size"))||void 0===r?void 0:r.value)||5)*1024,b={ERROR:null===(o=null===(s=document.querySelector("#pyrunner_log_error"))||void 0===s?void 0:s.checked)||void 0===o||o,WARN:null===(i=null===(l=document.querySelector("#pyrunner_log_warn"))||void 0===l?void 0:l.checked)||void 0===i||i,INFO:null===(u=null===(d=document.querySelector("#pyrunner_log_info"))||void 0===d?void 0:d.checked)||void 0===u||u,DEBUG:null!==(p=null===(v=document.querySelector("#pyrunner_log_debug"))||void 0===v?void 0:v.checked)&&void 0!==p&&p};try{const{getRequestHeaders:n}=SillyTavern.getContext(),e=await fetch("".concat(y.serverUrl,"/logs/config"),{method:"POST",headers:a(a({},n()),{},{"Content-Type":"application/json"}),body:JSON.stringify({enabled:m,directory:g,maxFileSize:h,levels:b})});if(!e.ok)throw new Error("Failed to save log config");const t=await e.json();C=t.config,f.success("Logging configuration saved")}catch(n){console.error("[".concat(c,"] Save log config error:"),n),f.error("Failed to save log config: ".concat(n.message))}}()}));const z=l.querySelector("#pyrunner_view_logs");z&&z.addEventListener("click",(async()=>{await async function(){const n=document.querySelector("#pyrunner_log_viewer"),e=document.querySelector("#pyrunner_log_file_select"),t=document.querySelector("#pyrunner_log_content");if(!n||!e||!t)return;n.style.display="block",t.innerHTML='<span class="pyrunner-hint">Loading log files...</span>';const r=await async function(){try{const{getRequestHeaders:n}=SillyTavern.getContext(),e=await fetch("".concat(y.serverUrl,"/logs/files"),{method:"GET",headers:n()});if(!e.ok)return[];return(await e.json()).files||[]}catch(n){return console.error("[".concat(c,"] Failed to fetch log files:"),n),[]}}();if(0===r.length)return e.innerHTML='<option value="">No log files found</option>',void(t.innerHTML='<span class="pyrunner-hint">No log files available</span>');e.innerHTML=r.map((n=>{const e=Math.round(n.size/1024);return'<option value="'.concat(n.name,'">').concat(n.name," (").concat(e," KB)</option>")})).join(""),await L(r[0].name)}()}));const D=l.querySelector("#pyrunner_close_log_viewer");D&&D.addEventListener("click",(()=>{const n=l.querySelector("#pyrunner_log_viewer");n&&(n.style.display="none")}));const G=l.querySelector("#pyrunner_log_file_select");G&&G.addEventListener("change",(async n=>{n.target.value&&await L(n.target.value)}));const B=l.querySelector("#pyrunner_refresh_logs");B&&B.addEventListener("click",(async()=>{const n=l.querySelector("#pyrunner_log_file_select");n&&n.value&&await L(n.value)}));H(),"server"===y.executionMode&&E();const J=l.querySelector("#pyrunner_scope_character"),W=l.querySelector("#pyrunner_scope_global"),Y=l.querySelector(".pyrunner-func-character-row");J&&W&&(J.addEventListener("click",(()=>{y.functionScope="character",u(),J.classList.add("menu_button_selected"),W.classList.remove("menu_button_selected"),Y&&(Y.style.display="flex"),O(),V()})),W.addEventListener("click",(()=>{y.functionScope="global",u(),W.classList.add("menu_button_selected"),J.classList.remove("menu_button_selected"),Y&&(Y.style.display="none"),O(),V()})));const K=l.querySelector("#pyrunner_func_character_select");K&&K.addEventListener("change",(()=>{y.selectedCharacter=K.value,u(),O(),V()}));const Q=l.querySelector("#pyrunner_func_mode_select");Q&&(!async function(){const n=document.querySelector("#pyrunner_func_mode_select");if(!n)return;const e=y.executionMode,t=y.selectedVenv||"default";let r='<option value="pyodide">Pyodide</option>',o=["default"];try{const{getRequestHeaders:n}=SillyTavern.getContext(),e=await fetch("".concat(y.serverUrl,"/venvs"),{method:"GET",headers:n()});if(e.ok){const n=await e.json();n.venvs&&n.venvs.length>0&&(o=n.venvs)}}catch(n){console.log("[SillyTavern-PyRunner] Could not fetch venvs for function select: ".concat(n.message))}o.forEach((n=>{const o="server"===e&&n===t;r+='<option value="'.concat(n,'"').concat(o?" selected":"",">").concat(n,"</option>")})),n.innerHTML=r,"pyodide"===e?n.value="pyodide":o.includes(t)?n.value=t:n.value="default"}(),Q.addEventListener("change",(()=>{O()})));const Z=l.querySelector("#pyrunner_func_search");Z&&Z.addEventListener("input",(()=>{O(Z.value)}));const $=l.querySelector("#pyrunner_create_function");$&&$.addEventListener("click",(()=>{I()}));const X=l.querySelector("#pyrunner_modal_close"),nn=l.querySelector("#pyrunner_modal_cancel");X&&X.addEventListener("click",F);nn&&nn.addEventListener("click",F);const en=l.querySelector("#pyrunner_modal_save");en&&en.addEventListener("click",M);const tn=l.querySelector("#pyrunner_func_modal");tn&&tn.addEventListener("click",(n=>{n.target===tn&&F()}));O()}(),console.log("[".concat(c,"] Extension loaded"))}))})();