# Dockerfile for PyRunner Playwright Tests
# Provides isolated environment with SillyTavern, Python, and Playwright

FROM mcr.microsoft.com/playwright:v1.40.0-jammy

# Install Python and venv
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Install SillyTavern
RUN git clone https://github.com/SillyTavern/SillyTavern.git /app/sillytavern
WORKDIR /app/sillytavern
RUN npm install

# Enable server plugins in config
RUN echo "enableServerPlugins: true" >> config.yaml

# Copy PyRunner extension files
WORKDIR /app
COPY . /app/pyrunner-extension

# Install PyRunner extension into SillyTavern
RUN mkdir -p /app/sillytavern/public/scripts/extensions/third-party/SillyTavern-PyRunner && \
    cp -r /app/pyrunner-extension/dist/* /app/sillytavern/public/scripts/extensions/third-party/SillyTavern-PyRunner/ && \
    cp /app/pyrunner-extension/manifest.json /app/sillytavern/public/scripts/extensions/third-party/SillyTavern-PyRunner/

# Install PyRunner server plugin
RUN mkdir -p /app/sillytavern/plugins/pyrunner && \
    cp /app/pyrunner-extension/server-plugin/index.js /app/sillytavern/plugins/pyrunner/

# Install test dependencies
WORKDIR /app/pyrunner-extension
RUN npm install && \
    npx playwright install chromium

# Expose SillyTavern port
EXPOSE 8000

# Default command runs tests
CMD ["npm", "test"]
